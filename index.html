<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>üìç –ù–∞–≤–∏–≥–∞—Ç–æ—Ä —Å –¥–≤–∏–∂–µ–Ω–∏–µ–º —Å—Ç—Ä–µ–ª–∫–∏</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* iOS-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ —Å—Ç–∏–ª–∏ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }

        html {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #000;
            color: white;
            height: 100vh;
            height: -webkit-fill-available;
            width: 100vw;
            overflow: hidden;
            position: fixed;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: none;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
            width: 100vw;
            background: #000;
            position: relative;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä–∞ */
        .nav-header {
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        .nav-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #007AFF, #5856D6);
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .nav-text h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .nav-text p {
            font-size: 13px;
            opacity: 0.7;
            margin-top: 2px;
        }

        /* –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ */
        .nav-upload-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-upload-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.95);
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #000;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã */
        .map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            overflow: hidden;
            touch-action: none;
        }

        #mapCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
            background: #000;
        }

        /* –°—Ç—Ä–µ–ª–∫–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è */
        .location-arrow {
            position: absolute;
            width: 60px;
            height: 60px;
            z-index: 100;
            pointer-events: none;
            filter: drop-shadow(0 0 10px rgba(0, 122, 255, 0.5));
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }

        .arrow-icon {
            width: 100%;
            height: 100%;
        }

        /* –°–ª–µ–¥ —Å—Ç—Ä–µ–ª–∫–∏ (–ø—É—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è) */
        .arrow-trail {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 90;
            pointer-events: none;
        }

        #trailCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }

        /* –ü–∞–Ω–µ–ª—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç */
        .coordinates-panel {
            position: absolute;
            bottom: 120px;
            left: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 16px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 50;
        }

        .coord-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .coord-label {
            opacity: 0.7;
        }

        .coord-value {
            font-family: 'Menlo', 'Monaco', monospace;
            font-weight: 600;
            color: #007AFF;
        }

        /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .control-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 12px;
            z-index: 100;
        }

        .control-btn {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 12px;
            padding: 14px;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-touch-callout: none;
            user-select: none;
        }

        .control-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.95);
        }

        .control-btn i {
            font-size: 22px;
        }

        .control-btn span {
            font-size: 12px;
            font-weight: 500;
        }

        .control-btn.primary {
            background: linear-gradient(135deg, #007AFF, #5856D6);
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã */
        .indicators {
            position: absolute;
            top: 16px;
            left: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 50;
        }

        .indicator {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .indicator i {
            color: #34C759;
            font-size: 16px;
        }

        .indicator span {
            opacity: 0.9;
        }

        /* –ö–æ–º–ø–∞—Å */
        .compass {
            position: absolute;
            top: 100px;
            right: 16px;
            width: 70px;
            height: 70px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .compass-arrow {
            width: 4px;
            height: 25px;
            background: #FF3B30;
            border-radius: 2px;
            transform-origin: bottom;
        }

        /* –ú–∞—Å—à—Ç–∞–± */
        .zoom-controls {
            position: absolute;
            right: 16px;
            bottom: 200px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 50;
        }

        .zoom-btn {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .zoom-btn:active {
            background: rgba(255, 255, 255, 0.1);
        }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è */
        .movement-settings {
            position: absolute;
            top: 100px;
            left: 16px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            z-index: 50;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .setting-label {
            opacity: 0.8;
        }

        .setting-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            padding: 4px 8px;
            width: 60px;
            text-align: center;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 14px 20px;
            border-radius: 14px;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 300px;
            width: auto;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .notification i {
            font-size: 18px;
        }

        .notification.success i {
            color: #34C759;
        }

        .notification.error i {
            color: #FF3B30;
        }

        .notification.warning i {
            color: #FF9500;
        }

        /* –ó–∞–≥—Ä—É–∑—á–∏–∫ */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .loader.show {
            opacity: 1;
            pointer-events: all;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes moveArrow {
            0% { transform: translate(-50%, -50%); }
            100% { transform: translate(var(--target-x), var(--target-y)); }
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-height: 700px) {
            .coordinates-panel {
                bottom: 100px;
                padding: 12px;
            }
            
            .control-panel {
                padding: 12px;
            }
            
            .control-btn {
                padding: 12px;
            }
        }

        @media (max-width: 400px) {
            .control-btn span {
                font-size: 11px;
            }
            
            .coordinates-panel {
                left: 8px;
                right: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
        <div class="nav-header">
            <div class="nav-title">
                <div class="nav-icon">
                    <i class="fas fa-location-arrow"></i>
                </div>
                <div class="nav-text">
                    <h1>–ù–∞–≤–∏–≥–∞—Ç–æ—Ä</h1>
                    <p>–°—Ç—Ä–µ–ª–∫–∞ –¥–≤–∏–∂–µ—Ç—Å—è –ø–æ –∫–∞—Ä—Ç–µ</p>
                </div>
            </div>
            <button class="nav-upload-btn" id="navUploadBtn" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É">
                <i class="fas fa-map"></i>
            </button>
            <input type="file" id="mapUpload" accept="image/*" style="display: none;">
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
        <div class="main-content">
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã -->
            <div class="map-container" id="mapContainer">
                <canvas id="mapCanvas"></canvas>
                <!-- –•–æ–ª—Å—Ç –¥–ª—è —Å–ª–µ–¥–∞ -->
                <div class="arrow-trail">
                    <canvas id="trailCanvas"></canvas>
                </div>
                
                <!-- –°—Ç—Ä–µ–ª–∫–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è -->
                <div class="location-arrow" id="locationArrow">
                    <svg class="arrow-icon" viewBox="0 0 100 100">
                        <defs>
                            <radialGradient id="arrowGrad" cx="50%" cy="50%">
                                <stop offset="0%" stop-color="#007AFF"/>
                                <stop offset="100%" stop-color="#0056CC"/>
                            </radialGradient>
                            <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                                <feGaussianBlur stdDeviation="3" result="blur"/>
                                <feMerge>
                                    <feMergeNode in="blur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        <path d="M50 15 L60 50 L50 85 L40 50 Z" 
                              fill="url(#arrowGrad)" 
                              stroke="#FFFFFF" 
                              stroke-width="2"
                              filter="url(#glow)"/>
                        <circle cx="50" cy="50" r="12" fill="#FFFFFF" opacity="0.3"/>
                        <circle cx="50" cy="50" r="6" fill="#FFFFFF"/>
                    </svg>
                </div>
            </div>

            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã -->
            <div class="indicators">
                <div class="indicator" id="gpsIndicator">
                    <i class="fas fa-satellite"></i>
                    <span>GPS: –ü–æ–∏—Å–∫...</span>
                </div>
                <div class="indicator" id="accuracyIndicator">
                    <i class="fas fa-bullseye"></i>
                    <span>–¢–æ—á–Ω–æ—Å—Ç—å: -- –º</span>
                </div>
            </div>

            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è -->
            <div class="movement-settings" id="movementSettings">
                <div class="setting-item">
                    <span class="setting-label">–°–∫–æ—Ä–æ—Å—Ç—å:</span>
                    <input type="number" id="speedMultiplier" class="setting-input" value="1" min="0.1" max="10" step="0.1">
                </div>
                <div class="setting-item">
                    <span class="setting-label">–°–ª–µ–¥:</span>
                    <button class="setting-btn" id="toggleTrail" style="background: rgba(255,255,255,0.1); border: none; border-radius: 6px; padding: 4px 8px; color: white; font-size: 12px;">
                        –í–ö–õ
                    </button>
                </div>
            </div>

            <!-- –ö–æ–º–ø–∞—Å -->
            <div class="compass" id="compass">
                <div class="compass-arrow" id="compassArrow"></div>
            </div>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–æ–º -->
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomIn">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="zoom-btn" id="zoomOut">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="zoom-btn" id="resetView">
                    <i class="fas fa-crosshairs"></i>
                </button>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
            <div class="coordinates-panel">
                <div class="coord-row">
                    <span class="coord-label">–ü–æ–∑–∏—Ü–∏—è X:</span>
                    <span class="coord-value" id="posX">0</span>
                </div>
                <div class="coord-row">
                    <span class="coord-label">–ü–æ–∑–∏—Ü–∏—è Y:</span>
                    <span class="coord-value" id="posY">0</span>
                </div>
                <div class="coord-row">
                    <span class="coord-label">–°–º–µ—â–µ–Ω–∏–µ:</span>
                    <span class="coord-value" id="offset">0 –º</span>
                </div>
                <div class="coord-row">
                    <span class="coord-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</span>
                    <span class="coord-value" id="heading">‚Äî¬∞</span>
                </div>
            </div>
        </div>

        <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="control-panel">
            <button class="control-btn" id="locateBtn">
                <i class="fas fa-crosshairs"></i>
                <span>–¶–µ–Ω—Ç—Ä</span>
            </button>
            <button class="control-btn" id="moveBtn">
                <i class="fas fa-walking"></i>
                <span>–î–≤–∏–∂–µ–Ω–∏–µ</span>
            </button>
            <button class="control-btn" id="compassBtn">
                <i class="fas fa-compass"></i>
                <span>–ö–æ–º–ø–∞—Å</span>
            </button>
            <button class="control-btn primary" id="saveBtn">
                <i class="fas fa-save"></i>
                <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
            </button>
        </div>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div class="notification" id="notification">
            <i class="fas fa-info-circle"></i>
            <span id="notificationText">–°–æ–æ–±—â–µ–Ω–∏–µ</span>
        </div>

        <!-- –ó–∞–≥—Ä—É–∑—á–∏–∫ -->
        <div class="loader" id="loader">
            <div class="spinner"></div>
        </div>
    </div>

    <script>
        // –ö–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –¥–≤–∏–∂–µ–Ω–∏–µ–º —Å—Ç—Ä–µ–ª–∫–∏
        class MobileNavigator {
            constructor() {
                this.canvas = document.getElementById('mapCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.trailCanvas = document.getElementById('trailCanvas');
                this.trailCtx = this.trailCanvas.getContext('2d');
                this.locationArrow = document.getElementById('locationArrow');
                this.compassArrow = document.getElementById('compassArrow');
                
                this.userImage = null;
                this.isDragging = false;
                this.dragStart = { x: 0, y: 0 };
                this.imagePosition = { x: 0, y: 0 };
                this.scale = 1;
                this.minScale = 0.1;
                this.maxScale = 3;
                this.tracking = false;
                this.compassActive = false;
                this.watchId = null;
                this.moving = false;
                
                // –ü–æ–∑–∏—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ (–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö –∫–∞—Ä—Ç—ã)
                this.arrowPosition = { x: 0, y: 0 };
                this.lastPosition = null;
                this.trailPoints = [];
                this.trailEnabled = true;
                this.speedMultiplier = 1;
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è
                this.moveStep = 10; // —à–∞–≥ –¥–≤–∏–∂–µ–Ω–∏—è –≤ –ø–∏–∫—Å–µ–ª—è—Ö
                this.currentDirection = null;
                
                this.init();
            }
            
            init() {
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => this.resizeCanvas(), 100);
                });
                
                this.setupEventListeners();
                this.showNotification('–ù–∞–≤–∏–≥–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
                
                // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å—Ç—Ä–µ–ª–∫—É
                this.centerArrow();
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
                this.loadSettings();
                
                // iOS PWA –ø–æ–¥–¥–µ—Ä–∂–∫–∞
                if ('standalone' in navigator) {
                    this.showNotification('–î–æ–±–∞–≤—å—Ç–µ –≤ —ç–∫—Ä–∞–Ω "–î–æ–º–æ–π"', 'info', 4000);
                }
            }
            
            resizeCanvas() {
                const container = document.getElementById('mapContainer');
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
                this.trailCanvas.width = container.clientWidth;
                this.trailCanvas.height = container.clientHeight;
                
                if (this.userImage) {
                    this.centerImage();
                } else {
                    this.drawWelcomeScreen();
                }
                
                this.drawTrail();
            }
            
            drawWelcomeScreen() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // –§–æ–Ω
                const gradient = this.ctx.createLinearGradient(0, 0, this.canvas.width, this.canvas.height);
                gradient.addColorStop(0, '#000000');
                gradient.addColorStop(1, '#1a1a2e');
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // –ò–∫–æ–Ω–∫–∞ –∏ —Ç–µ–∫—Å—Ç
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                this.ctx.font = 'bold 24px -apple-system, BlinkMacSystemFont';
                this.ctx.fillStyle = '#FFFFFF';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('–ù–∞–≤–∏–≥–∞—Ç–æ—Ä —Å–æ —Å—Ç—Ä–µ–ª–∫–æ–π', centerX, centerY);
                
                // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
                this.ctx.font = '16px -apple-system, BlinkMacSystemFont';
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                this.ctx.fillText('–°—Ç—Ä–µ–ª–∫–∞ –¥–≤–∏–≥–∞–µ—Ç—Å—è –ø–æ –∫–∞—Ä—Ç–µ', centerX, centerY + 40);
                this.ctx.fillText('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–î–≤–∏–∂–µ–Ω–∏–µ"', centerX, centerY + 70);
            }
            
            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                if (this.userImage) {
                    this.ctx.save();
                    this.ctx.translate(this.imagePosition.x, this.imagePosition.y);
                    this.ctx.scale(this.scale, this.scale);
                    this.ctx.drawImage(this.userImage, 0, 0);
                    this.ctx.restore();
                    
                    this.drawGrid();
                } else {
                    this.drawWelcomeScreen();
                }
                
                this.updatePositionDisplay();
            }
            
            drawGrid() {
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
                this.ctx.lineWidth = 1;
                
                const gridSize = 50 * this.scale;
                const offsetX = this.imagePosition.x % gridSize;
                const offsetY = this.imagePosition.y % gridSize;
                
                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
                for (let x = -offsetX; x < this.canvas.width; x += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x, this.canvas.height);
                    this.ctx.stroke();
                }
                
                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
                for (let y = -offsetY; y < this.canvas.height; y += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y);
                    this.ctx.lineTo(this.canvas.width, y);
                    this.ctx.stroke();
                }
                
                // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫—Ä–µ—Å—Ç
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                
                this.ctx.strokeStyle = 'rgba(255, 0, 0, 0.3)';
                this.ctx.lineWidth = 2;
                
                this.ctx.beginPath();
                this.ctx.moveTo(centerX - 15, centerY);
                this.ctx.lineTo(centerX + 15, centerY);
                this.ctx.moveTo(centerX, centerY - 15);
                this.ctx.lineTo(centerX, centerY + 15);
                this.ctx.stroke();
            }
            
            drawTrail() {
                if (!this.trailEnabled || this.trailPoints.length < 2) {
                    this.trailCtx.clearRect(0, 0, this.trailCanvas.width, this.trailCanvas.height);
                    return;
                }
                
                this.trailCtx.clearRect(0, 0, this.trailCanvas.width, this.trailCanvas.height);
                
                // –†–∏—Å—É–µ–º –ø—É—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è
                this.trailCtx.strokeStyle = 'rgba(0, 122, 255, 0.5)';
                this.trailCtx.lineWidth = 3;
                this.trailCtx.lineCap = 'round';
                this.trailCtx.lineJoin = 'round';
                
                this.trailCtx.beginPath();
                
                // –ü–µ—Ä–µ–≤–æ–¥–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ —Å–∏—Å—Ç–µ–º—ã –∫–∞—Ä—Ç—ã –≤ —ç–∫—Ä–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                for (let i = 0; i < this.trailPoints.length; i++) {
                    const point = this.trailPoints[i];
                    const screenX = point.x * this.scale + this.imagePosition.x;
                    const screenY = point.y * this.scale + this.imagePosition.y;
                    
                    if (i === 0) {
                        this.trailCtx.moveTo(screenX, screenY);
                    } else {
                        this.trailCtx.lineTo(screenX, screenY);
                    }
                }
                
                this.trailCtx.stroke();
                
                // –†–∏—Å—É–µ–º —Ç–æ—á–∫–∏ –ø—É—Ç–∏
                this.trailCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                for (let i = 0; i < this.trailPoints.length; i += 10) {
                    const point = this.trailPoints[i];
                    const screenX = point.x * this.scale + this.imagePosition.x;
                    const screenY = point.y * this.scale + this.imagePosition.y;
                    
                    this.trailCtx.beginPath();
                    this.trailCtx.arc(screenX, screenY, 3, 0, Math.PI * 2);
                    this.trailCtx.fill();
                }
            }
            
            centerArrow() {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä–µ–ª–∫—É –≤ —Ü–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞
                this.arrowPosition.x = this.canvas.width / 2;
                this.arrowPosition.y = this.canvas.height / 2;
                this.updateArrowPosition();
            }
            
            updateArrowPosition() {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
                this.locationArrow.style.left = `${this.arrowPosition.x}px`;
                this.locationArrow.style.top = `${this.arrowPosition.y}px`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É –≤ –ø—É—Ç—å
                if (this.trailEnabled) {
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —ç–∫—Ä–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–∞—Ä—Ç—ã
                    const mapX = (this.arrowPosition.x - this.imagePosition.x) / this.scale;
                    const mapY = (this.arrowPosition.y - this.imagePosition.y) / this.scale;
                    
                    this.trailPoints.push({ x: mapX, y: mapY });
                    
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫
                    if (this.trailPoints.length > 1000) {
                        this.trailPoints.shift();
                    }
                    
                    this.drawTrail();
                }
            }
            
            moveArrow(direction) {
                if (!this.moving) return;
                
                const step = this.moveStep * this.speedMultiplier;
                
                switch(direction) {
                    case 'up':
                        this.arrowPosition.y -= step;
                        break;
                    case 'down':
                        this.arrowPosition.y += step;
                        break;
                    case 'left':
                        this.arrowPosition.x -= step;
                        break;
                    case 'right':
                        this.arrowPosition.x += step;
                        break;
                    case 'up-left':
                        this.arrowPosition.x -= step * 0.7;
                        this.arrowPosition.y -= step * 0.7;
                        break;
                    case 'up-right':
                        this.arrowPosition.x += step * 0.7;
                        this.arrowPosition.y -= step * 0.7;
                        break;
                    case 'down-left':
                        this.arrowPosition.x -= step * 0.7;
                        this.arrowPosition.y += step * 0.7;
                        break;
                    case 'down-right':
                        this.arrowPosition.x += step * 0.7;
                        this.arrowPosition.y += step * 0.7;
                        break;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
                const padding = 50;
                this.arrowPosition.x = Math.max(padding, Math.min(this.canvas.width - padding, this.arrowPosition.x));
                this.arrowPosition.y = Math.max(padding, Math.min(this.canvas.height - padding, this.arrowPosition.y));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å—Ç—Ä–µ–ª–∫–∏
                this.updateArrowPosition();
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫–∞—Ä—Ç—É –µ—Å–ª–∏ —Å—Ç—Ä–µ–ª–∫–∞ —É –∫—Ä–∞—è
                this.scrollMapIfNeeded();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏
                this.updatePositionDisplay();
                
                // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Å—Ç—Ä–µ–ª–∫—É –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è
                this.rotateArrowToDirection(direction);
            }
            
            rotateArrowToDirection(direction) {
                const rotations = {
                    'up': 0,
                    'up-right': 45,
                    'right': 90,
                    'down-right': 135,
                    'down': 180,
                    'down-left': 225,
                    'left': 270,
                    'up-left': 315
                };
                
                if (rotations[direction] !== undefined) {
                    this.locationArrow.style.transform = `translate(-50%, -50%) rotate(${rotations[direction]}deg)`;
                }
            }
            
            scrollMapIfNeeded() {
                if (!this.userImage) return;
                
                const threshold = 100; // —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –∫—Ä–∞—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                const scrollSpeed = 5 * this.speedMultiplier;
                
                let needsRedraw = false;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–µ–≤—ã–π –∫—Ä–∞–π
                if (this.arrowPosition.x < threshold) {
                    this.imagePosition.x += scrollSpeed;
                    needsRedraw = true;
                }
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π
                else if (this.arrowPosition.x > this.canvas.width - threshold) {
                    this.imagePosition.x -= scrollSpeed;
                    needsRedraw = true;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Ö–Ω–∏–π –∫—Ä–∞–π
                if (this.arrowPosition.y < threshold) {
                    this.imagePosition.y += scrollSpeed;
                    needsRedraw = true;
                }
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∏–∂–Ω–∏–π –∫—Ä–∞–π
                else if (this.arrowPosition.y > this.canvas.height - threshold) {
                    this.imagePosition.y -= scrollSpeed;
                    needsRedraw = true;
                }
                
                if (needsRedraw) {
                    this.draw();
                    this.drawTrail();
                }
            }
            
            updatePositionDisplay() {
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Å—Ç—Ä–µ–ª–∫–∏
                document.getElementById('posX').textContent = Math.round(this.arrowPosition.x);
                document.getElementById('posY').textContent = Math.round(this.arrowPosition.y);
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                const distance = Math.round(Math.sqrt(
                    Math.pow(this.arrowPosition.x - centerX, 2) + 
                    Math.pow(this.arrowPosition.y - centerY, 2)
                ));
                document.getElementById('offset').textContent = `${distance} –º`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                if (this.currentDirection) {
                    const directions = {
                        'up': '0¬∞ (–°)',
                        'up-right': '45¬∞ (–°–í)',
                        'right': '90¬∞ (–í)',
                        'down-right': '135¬∞ (–Æ–í)',
                        'down': '180¬∞ (–Æ)',
                        'down-left': '225¬∞ (–Æ–ó)',
                        'left': '270¬∞ (–ó)',
                        'up-left': '315¬∞ (–°–ó)'
                    };
                    document.getElementById('heading').textContent = directions[this.currentDirection] || '‚Äî¬∞';
                }
            }
            
            loadImage(file) {
                if (!file.type.match('image.*')) {
                    this.showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
                    return;
                }
                
                this.showLoader();
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        this.userImage = img;
                        this.centerImage();
                        this.showNotification(`–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞: ${file.name}`, 'success');
                        this.hideLoader();
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                        localStorage.setItem('lastMap', e.target.result);
                        localStorage.setItem('lastMapName', file.name);
                        
                        // –û—á–∏—â–∞–µ–º –ø—É—Ç—å
                        this.trailPoints = [];
                        this.drawTrail();
                    };
                    img.onerror = () => {
                        this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
                        this.hideLoader();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            centerImage() {
                if (!this.userImage) return;
                
                this.imagePosition.x = (this.canvas.width - this.userImage.width * this.scale) / 2;
                this.imagePosition.y = (this.canvas.height - this.userImage.height * this.scale) / 2;
                this.draw();
                this.drawTrail();
            }
            
            zoomIn() {
                if (this.scale < this.maxScale) {
                    this.scale *= 1.2;
                    this.adjustZoomPosition(1.2);
                    this.draw();
                    this.drawTrail();
                }
            }
            
            zoomOut() {
                if (this.scale > this.minScale) {
                    this.scale /= 1.2;
                    this.adjustZoomPosition(1/1.2);
                    this.draw();
                    this.drawTrail();
                }
            }
            
            adjustZoomPosition(factor) {
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                
                this.imagePosition.x = centerX - (centerX - this.imagePosition.x) * factor;
                this.imagePosition.y = centerY - (centerY - this.imagePosition.y) * factor;
            }
            
            resetView() {
                this.scale = 1;
                this.centerImage();
                this.centerArrow();
                this.showNotification('–í–∏–¥ —Å–±—Ä–æ—à–µ–Ω', 'info');
            }
            
            toggleMovement() {
                this.moving = !this.moving;
                
                if (this.moving) {
                    document.getElementById('moveBtn').innerHTML = 
                        '<i class="fas fa-stop"></i><span>–°—Ç–æ–ø</span>';
                    this.showNotification('–†–µ–∂–∏–º –¥–≤–∏–∂–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω', 'success');
                } else {
                    document.getElementById('moveBtn').innerHTML = 
                        '<i class="fas fa-walking"></i><span>–î–≤–∏–∂–µ–Ω–∏–µ</span>';
                    this.showNotification('–†–µ–∂–∏–º –¥–≤–∏–∂–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω', 'info');
                }
            }
            
            toggleCompass() {
                this.compassActive = !this.compassActive;
                
                if (this.compassActive) {
                    if (typeof DeviceOrientationEvent !== 'undefined' && 
                        typeof DeviceOrientationEvent.requestPermission === 'function') {
                        
                        DeviceOrientationEvent.requestPermission()
                            .then(permissionState => {
                                if (permissionState === 'granted') {
                                    this.enableCompass();
                                } else {
                                    this.compassActive = false;
                                    this.showNotification('–î–æ—Å—Ç—É–ø –∫ –∫–æ–º–ø–∞—Å—É –∑–∞–ø—Ä–µ—â–µ–Ω', 'error');
                                }
                            })
                            .catch(error => {
                                console.error(error);
                                this.compassActive = false;
                            });
                    } else {
                        this.enableCompass();
                    }
                } else {
                    this.disableCompass();
                }
            }
            
            enableCompass() {
                window.addEventListener('deviceorientation', this.handleDeviceOrientation.bind(this));
                document.getElementById('compassBtn').innerHTML = 
                    '<i class="fas fa-compass"></i><span>–ö–æ–º–ø–∞—Å: –í–ö–õ</span>';
                this.showNotification('–ö–æ–º–ø–∞—Å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω', 'success');
            }
            
            disableCompass() {
                window.removeEventListener('deviceorientation', this.handleDeviceOrientation.bind(this));
                document.getElementById('compassBtn').innerHTML = 
                    '<i class="fas fa-compass"></i><span>–ö–æ–º–ø–∞—Å</span>';
            }
            
            handleDeviceOrientation(event) {
                if (event.alpha !== null) {
                    const heading = event.alpha;
                    this.compassArrow.style.transform = `rotate(${-heading}deg)`;
                    this.locationArrow.style.transform = `translate(-50%, -50%) rotate(${heading}deg)`;
                }
            }
            
            toggleTrail() {
                this.trailEnabled = !this.trailEnabled;
                const trailBtn = document.getElementById('toggleTrail');
                trailBtn.textContent = this.trailEnabled ? '–í–ö–õ' : '–í–´–ö–õ';
                trailBtn.style.background = this.trailEnabled ? 
                    'rgba(0, 122, 255, 0.5)' : 'rgba(255, 255, 255, 0.1)';
                
                this.drawTrail();
                this.showNotification(`–°–ª–µ–¥ ${this.trailEnabled ? '–≤–∫–ª—é—á–µ–Ω' : '–≤—ã–∫–ª—é—á–µ–Ω'}`, 'info');
            }
            
            saveSettings() {
                const settings = {
                    speedMultiplier: this.speedMultiplier,
                    trailEnabled: this.trailEnabled,
                    arrowPosition: this.arrowPosition,
                    imagePosition: this.imagePosition,
                    scale: this.scale
                };
                
                localStorage.setItem('navigatorSettings', JSON.stringify(settings));
                this.showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            }
            
            loadSettings() {
                const saved = localStorage.getItem('navigatorSettings');
                if (saved) {
                    try {
                        const settings = JSON.parse(saved);
                        this.speedMultiplier = settings.speedMultiplier || 1;
                        this.trailEnabled = settings.trailEnabled !== false;
                        this.arrowPosition = settings.arrowPosition || { x: this.canvas.width / 2, y: this.canvas.height / 2 };
                        this.imagePosition = settings.imagePosition || { x: 0, y: 0 };
                        this.scale = settings.scale || 1;
                        
                        document.getElementById('speedMultiplier').value = this.speedMultiplier;
                        document.getElementById('toggleTrail').textContent = this.trailEnabled ? '–í–ö–õ' : '–í–´–ö–õ';
                        document.getElementById('toggleTrail').style.background = this.trailEnabled ? 
                            'rgba(0, 122, 255, 0.5)' : 'rgba(255, 255, 255, 0.1)';
                        
                        this.updateArrowPosition();
                        this.draw();
                        this.drawTrail();
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', e);
                    }
                }
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã
                const lastMap = localStorage.getItem('lastMap');
                if (lastMap) {
                    const img = new Image();
                    img.onload = () => {
                        this.userImage = img;
                        this.draw();
                        const mapName = localStorage.getItem('lastMapName') || '–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞';
                        this.showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–∞ ${mapName}`, 'info');
                    };
                    img.src = lastMap;
                }
            }
            
            showNotification(message, type = 'info', duration = 3000) {
                const notification = document.getElementById('notification');
                const text = document.getElementById('notificationText');
                
                notification.className = `notification ${type}`;
                text.textContent = message;
                
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, duration);
            }
            
            showLoader() {
                document.getElementById('loader').classList.add('show');
            }
            
            hideLoader() {
                document.getElementById('loader').classList.remove('show');
            }
            
            setupEventListeners() {
                // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã
                document.getElementById('navUploadBtn').addEventListener('click', () => {
                    document.getElementById('mapUpload').click();
                });
                
                document.getElementById('mapUpload').addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        this.loadImage(e.target.files[0]);
                    }
                });
                
                // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                document.getElementById('locateBtn').addEventListener('click', () => {
                    this.resetView();
                });
                
                document.getElementById('moveBtn').addEventListener('click', () => {
                    this.toggleMovement();
                });
                
                document.getElementById('compassBtn').addEventListener('click', () => {
                    this.toggleCompass();
                });
                
                document.getElementById('saveBtn').addEventListener('click', () => {
                    this.saveSettings();
                });
                
                // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
                document.getElementById('zoomIn').addEventListener('click', () => this.zoomIn());
                document.getElementById('zoomOut').addEventListener('click', () => this.zoomOut());
                document.getElementById('resetView').addEventListener('click', () => this.resetView());
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è
                document.getElementById('speedMultiplier').addEventListener('change', (e) => {
                    this.speedMultiplier = parseFloat(e.target.value) || 1;
                });
                
                document.getElementById('toggleTrail').addEventListener('click', () => {
                    this.toggleTrail();
                });
                
                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–µ–ª–∫–æ–π —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
                document.addEventListener('keydown', (e) => {
                    if (!this.moving) return;
                    
                    switch(e.key) {
                        case 'ArrowUp':
                            e.preventDefault();
                            this.currentDirection = 'up';
                            this.moveArrow('up');
                            break;
                        case 'ArrowDown':
                            e.preventDefault();
                            this.currentDirection = 'down';
                            this.moveArrow('down');
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            this.currentDirection = 'left';
                            this.moveArrow('left');
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            this.currentDirection = 'right';
                            this.moveArrow('right');
                            break;
                    }
                });
                
                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–µ–ª–∫–æ–π —Å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –¥–∂–æ–π—Å—Ç–∏–∫–∞
                this.createVirtualJoystick();
                
                // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (this.userImage && e.touches.length === 1) {
                        this.isDragging = true;
                        this.dragStart.x = e.touches[0].clientX - this.imagePosition.x;
                        this.dragStart.y = e.touches[0].clientY - this.imagePosition.y;
                    }
                }, { passive: false });
                
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (this.isDragging && this.userImage && e.touches.length === 1) {
                        this.imagePosition.x = e.touches[0].clientX - this.dragStart.x;
                        this.imagePosition.y = e.touches[0].clientY - this.dragStart.y;
                        this.draw();
                        this.drawTrail();
                    }
                }, { passive: false });
                
                this.canvas.addEventListener('touchend', () => {
                    this.isDragging = false;
                });
                
                // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∂–µ—Å—Ç–æ–º
                let initialDistance = 0;
                
                this.canvas.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 2 && this.userImage) {
                        initialDistance = Math.hypot(
                            e.touches[0].clientX - e.touches[1].clientX,
                            e.touches[0].clientY - e.touches[1].clientY
                        );
                    }
                });
                
                this.canvas.addEventListener('touchmove', (e) => {
                    if (e.touches.length === 2 && this.userImage && initialDistance > 0) {
                        e.preventDefault();
                        
                        const currentDistance = Math.hypot(
                            e.touches[0].clientX - e.touches[1].clientX,
                            e.touches[0].clientY - e.touches[1].clientY
                        );
                        
                        const delta = currentDistance - initialDistance;
                        if (Math.abs(delta) > 30) {
                            if (delta > 0) {
                                this.zoomIn();
                            } else {
                                this.zoomOut();
                            }
                            initialDistance = currentDistance;
                        }
                    }
                }, { passive: false });
                
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∂–µ—Å—Ç–æ–≤ iOS
                document.addEventListener('touchmove', (e) => {
                    if (e.target === this.canvas || e.target.closest('.map-container')) {
                        e.preventDefault();
                    }
                }, { passive: false });
            }
            
            createVirtualJoystick() {
                // –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –¥–∂–æ–π—Å—Ç–∏–∫ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                const joystickContainer = document.createElement('div');
                joystickContainer.style.cssText = `
                    position: absolute;
                    bottom: 120px;
                    left: 16px;
                    width: 150px;
                    height: 150px;
                    z-index: 50;
                    display: none;
                `;
                
                joystickContainer.innerHTML = `
                    <div style="position: relative; width: 100%; height: 100%;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                             width: 100px; height: 100px; background: rgba(0,0,0,0.5); border-radius: 50%;">
                        </div>
                        <button style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
                                width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.2); 
                                border: none; color: white; font-size: 20px;" id="joystickUp">‚Üë</button>
                        <button style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
                                width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.2); 
                                border: none; color: white; font-size: 20px;" id="joystickDown">‚Üì</button>
                        <button style="position: absolute; top: 50%; left: 10px; transform: translateY(-50%);
                                width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.2); 
                                border: none; color: white; font-size: 20px;" id="joystickLeft">‚Üê</button>
                        <button style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%);
                                width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.2); 
                                border: none; color: white; font-size: 20px;" id="joystickRight">‚Üí</button>
                        <button style="position: absolute; top: 25px; left: 25px; width: 30px; height: 30px; 
                                border-radius: 50%; background: rgba(255,255,255,0.2); border: none; 
                                color: white; font-size: 14px;" id="joystickUpLeft">‚Üñ</button>
                        <button style="position: absolute; top: 25px; right: 25px; width: 30px; height: 30px; 
                                border-radius: 50%; background: rgba(255,255,255,0.2); border: none; 
                                color: white; font-size: 14px;" id="joystickUpRight">‚Üó</button>
                        <button style="position: absolute; bottom: 25px; left: 25px; width: 30px; height: 30px; 
                                border-radius: 50%; background: rgba(255,255,255,0.2); border: none; 
                                color: white; font-size: 14px;" id="joystickDownLeft">‚Üô</button>
                        <button style="position: absolute; bottom: 25px; right: 25px; width: 30px; height: 30px; 
                                border-radius: 50%; background: rgba(255,255,255,0.2); border: none; 
                                color: white; font-size: 14px;" id="joystickDownRight">‚Üò</button>
                    </div>
                `;
                
                document.querySelector('.main-content').appendChild(joystickContainer);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∂–æ–π—Å—Ç–∏–∫ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞ –¥–≤–∏–∂–µ–Ω–∏—è
                const moveBtn = document.getElementById('moveBtn');
                moveBtn.addEventListener('click', () => {
                    if (this.moving) {
                        joystickContainer.style.display = 'block';
                    } else {
                        joystickContainer.style.display = 'none';
                    }
                });
                
                // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–∫–∞–º –¥–∂–æ–π—Å—Ç–∏–∫–∞
                const directions = {
                    'joystickUp': 'up',
                    'joystickDown': 'down',
                    'joystickLeft': 'left',
                    'joystickRight': 'right',
                    'joystickUpLeft': 'up-left',
                    'joystickUpRight': 'up-right',
                    'joystickDownLeft': 'down-left',
                    'joystickDownRight': 'down-right'
                };
                
                for (const [buttonId, direction] of Object.entries(directions)) {
                    document.getElementById(buttonId).addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        this.currentDirection = direction;
                        this.moveArrow(direction);
                        
                        // –ê–≤—Ç–æ–ø–æ–≤—Ç–æ—Ä –ø—Ä–∏ —É–¥–µ—Ä–∂–∞–Ω–∏–∏
                        const interval = setInterval(() => {
                            this.moveArrow(direction);
                        }, 100);
                        
                        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—Ç–ø—É—Å–∫–∞–Ω–∏–∏
                        const stopMoving = () => {
                            clearInterval(interval);
                            document.removeEventListener('touchend', stopMoving);
                        };
                        
                        document.addEventListener('touchend', stopMoving);
                    });
                }
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                window.navigator = new MobileNavigator();
            }, 100);
        });
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∂–µ—Å—Ç–æ–º –Ω–∞ iOS
        document.addEventListener('gesturestart', (e) => {
            e.preventDefault();
        });
    </script>
</body>
</html>