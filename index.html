<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>–ù–∞–≤–∏–≥–∞—Ç–æ—Ä –ø–æ –∫–∞—Ä—Ç–µ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }
        
        .container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        #mapCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #2c3e50;
            cursor: grab;
        }
        
        #arrow {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60px;
            height: 80px;
            transform-origin: center 80%;
            transition: transform 0.1s ease-out;
            pointer-events: none;
            z-index: 10;
            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.5));
        }
        
        .arrow-shape {
            width: 100%;
            height: 100%;
        }
        
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }
        
        .button {
            background: linear-gradient(135deg, #007AFF, #0056CC);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 15px;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        .button-secondary {
            background: rgba(40, 40, 40, 0.9);
        }
        
        .button-danger {
            background: linear-gradient(135deg, #FF3B30, #D70015);
        }
        
        .status-bar {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: white;
            padding: 12px 16px;
            border-radius: 15px;
            font-size: 15px;
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .sensor-data {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #8E8E93;
        }
        
        .sensor-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        #mapUpload {
            display: none;
        }
        
        .instructions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            max-width: 300px;
            z-index: 1000;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .instructions h3 {
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .instructions p {
            margin: 10px 0;
            line-height: 1.4;
            color: #8E8E93;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        .calibration {
            position: absolute;
            bottom: 120px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: white;
            padding: 15px;
            border-radius: 15px;
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .calibration.hidden {
            display: none;
        }
        
        .calibration button {
            margin-top: 10px;
        }
        
        .slider-container {
            margin: 15px 0;
        }
        
        .slider-container label {
            display: block;
            margin-bottom: 5px;
            color: #8E8E93;
        }
        
        input[type="range"] {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #007AFF;
            cursor: pointer;
        }
        
        .map-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .grid-line {
            stroke: rgba(255,255,255,0.1);
            stroke-width: 1;
        }
        
        .position-marker {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #FF3B30;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
        }
    </style>
</head>
<body>
    <div class="container">
        <canvas id="mapCanvas"></canvas>
        <svg class="map-grid" id="grid"></svg>
        <div id="arrow">
            <svg class="arrow-shape" viewBox="0 0 100 100">
                <defs>
                    <linearGradient id="arrowGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#007AFF;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#0056CC;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <polygon points="50,15 85,85 50,65 15,85" fill="url(#arrowGradient)"/>
                <circle cx="50" cy="50" r="10" fill="#0056CC"/>
            </svg>
        </div>
        
        <div class="status-bar">
            <div id="statusText">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–∞—Ä—Ç—É –¥–ª—è –Ω–∞—á–∞–ª–∞</div>
            <div class="sensor-data">
                <span class="sensor-item">üìç <span id="posX">0</span>, <span id="posY">0</span></span>
                <span class="sensor-item">üß≠ <span id="heading">0¬∞</span></span>
                <span class="sensor-item">‚ö° <span id="movement">0</span></span>
            </div>
        </div>
        
        <div class="instructions" id="instructions">
            <button class="close-btn" onclick="hideInstructions()">√ó</button>
            <h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h3>
            <p>1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –∫–∞—Ä—Ç—ã –º–µ—Å—Ç–Ω–æ—Å—Ç–∏</p>
            <p>2. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –¥–∞—Ç—á–∏–∫–∞–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞</p>
            <p>3. –ù–∞–∫–ª–æ–Ω—è–π—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –ø–æ–≤–æ—Ä–æ—Ç–∞ —Å—Ç—Ä–µ–ª–∫–∏</p>
            <p>4. –î–≤–∏–≥–∞–π—Ç–µ—Å—å –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –ø–æ –∫–∞—Ä—Ç–µ</p>
            <button class="button" onclick="hideInstructions()">–ü–æ–Ω—è—Ç–Ω–æ</button>
        </div>
        
        <div class="calibration hidden" id="calibrationPanel">
            <div>–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –¥–∞—Ç—á–∏–∫–æ–≤</div>
            <div class="slider-container">
                <label>–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è: <span id="sensitivityValue">5</span></label>
                <input type="range" id="sensitivitySlider" min="1" max="10" value="5">
            </div>
            <button class="button button-secondary" onclick="calibrateSensors()">–ö–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å</button>
        </div>
        
        <div class="controls">
            <input type="file" id="mapUpload" accept="image/*">
            <button class="button" onclick="document.getElementById('mapUpload').click()">
                üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É
            </button>
            <button class="button button-secondary" onclick="toggleCalibration()">
                ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
            <button class="button button-secondary" onclick="resetPosition()">
                üéØ –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å
            </button>
        </div>
    </div>

    <script>
        // –û—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        const mapCanvas = document.getElementById('mapCanvas');
        const ctx = mapCanvas.getContext('2d');
        const arrow = document.getElementById('arrow');
        const mapUpload = document.getElementById('mapUpload');
        const statusText = document.getElementById('statusText');
        const grid = document.getElementById('grid');
        const instructions = document.getElementById('instructions');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        const posXElement = document.getElementById('posX');
        const posYElement = document.getElementById('posY');
        const headingElement = document.getElementById('heading');
        const movementElement = document.getElementById('movement');
        const sensitivitySlider = document.getElementById('sensitivitySlider');
        const sensitivityValue = document.getElementById('sensitivityValue');
        const calibrationPanel = document.getElementById('calibrationPanel');
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let mapImage = null;
        let currentPosition = { x: 0, y: 0 };
        let mapOffset = { x: 0, y: 0 };
        let mapScale = 1;
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let lastOffset = { x: 0, y: 0 };
        
        // –î–∞–Ω–Ω—ã–µ —Å–µ–Ω—Å–æ—Ä–æ–≤
        let alpha = 0; // –ö–æ–º–ø–∞—Å (0-360)
        let beta = 0;  // –ù–∞–∫–ª–æ–Ω –≤–ø–µ—Ä–µ–¥/–Ω–∞–∑–∞–¥ (-180 –¥–æ 180)
        let gamma = 0; // –ù–∞–∫–ª–æ–Ω –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ (-90 –¥–æ 90)
        
        // –§–∏–ª—å—Ç—Ä—ã –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
        let smoothedGamma = 0;
        let lastAcceleration = { x: 0, y: 0, z: 0 };
        let velocity = { x: 0, y: 0 };
        let positionHistory = [];
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        let movementSensitivity = 5;
        let isCalibrating = false;
        let calibrationOffset = { x: 0, y: 0 };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            resizeCanvas();
            setupEventListeners();
            setupGrid();
            updateStatus('–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –∫–∞—Ä—Ç—ã');
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
            if (!localStorage.getItem('instructionsShown')) {
                instructions.style.display = 'block';
            }
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª–∞–π–¥–µ—Ä–∞
            sensitivitySlider.addEventListener('input', function() {
                movementSensitivity = parseInt(this.value);
                sensitivityValue.textContent = movementSensitivity;
            });
        }
        
        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ canvas
        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const rect = mapCanvas.getBoundingClientRect();
            
            mapCanvas.width = rect.width * dpr;
            mapCanvas.height = rect.height * dpr;
            
            ctx.scale(dpr, dpr);
            mapCanvas.style.width = rect.width + 'px';
            mapCanvas.style.height = rect.height + 'px';
            
            if (mapImage) {
                centerMap();
            } else {
                currentPosition.x = rect.width / 2;
                currentPosition.y = rect.height / 2;
            }
            
            drawMap();
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ç–∫–∏
        function setupGrid() {
            const gridSize = 50;
            const width = mapCanvas.width / (window.devicePixelRatio || 1);
            const height = mapCanvas.height / (window.devicePixelRatio || 1);
            
            grid.innerHTML = '';
            
            for (let x = 0; x < width; x += gridSize) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('class', 'grid-line');
                line.setAttribute('x1', x);
                line.setAttribute('y1', 0);
                line.setAttribute('x2', x);
                line.setAttribute('y2', height);
                grid.appendChild(line);
            }
            
            for (let y = 0; y < height; y += gridSize) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('class', 'grid-line');
                line.setAttribute('x1', 0);
                line.setAttribute('y1', y);
                line.setAttribute('x2', width);
                line.setAttribute('y2', height);
                grid.appendChild(line);
            }
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã
            mapUpload.addEventListener('change', handleMapUpload);
            
            // –°–µ–Ω—Å–æ—Ä—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            if (typeof DeviceOrientationEvent !== 'undefined') {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    // iOS 13+
                    document.addEventListener('click', requestMotionPermission, { once: true });
                } else {
                    // Android –∏ –¥—Ä—É–≥–∏–µ
                    window.addEventListener('deviceorientation', handleOrientation);
                    window.addEventListener('devicemotion', handleMotion);
                }
            }
            
            // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã
            mapCanvas.addEventListener('mousedown', startDrag);
            mapCanvas.addEventListener('touchstart', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
            
            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
            window.addEventListener('resize', resizeCanvas);
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
            
            document.addEventListener('touchmove', function(e) {
                if (e.scale !== 1) {
                    e.preventDefault();
                }
            }, { passive: false });
        }
        
        // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—á–∏–∫–æ–≤ (iOS)
        function requestMotionPermission() {
            DeviceOrientationEvent.requestPermission()
                .then(response => {
                    if (response === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation);
                        window.addEventListener('devicemotion', handleMotion);
                        updateStatus('–î–∞—Ç—á–∏–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã');
                    } else {
                        updateStatus('–î–∞—Ç—á–∏–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ');
                    }
                })
                .catch(console.error);
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã
        function handleMapUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                mapImage = new Image();
                mapImage.onload = function() {
                    centerMap();
                    drawMap();
                    updateStatus('–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ù–∞–∫–ª–æ–Ω—è–π—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.');
                };
                mapImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã
        function centerMap() {
            if (!mapImage) return;
            
            const canvasWidth = mapCanvas.width / (window.devicePixelRatio || 1);
            const canvasHeight = mapCanvas.height / (window.devicePixelRatio || 1);
            
            mapScale = Math.min(
                canvasWidth / mapImage.width,
                canvasHeight / mapImage.height,
                1
            );
            
            mapOffset.x = (canvasWidth - mapImage.width * mapScale) / 2;
            mapOffset.y = (canvasHeight - mapImage.height * mapScale) / 2;
            
            currentPosition.x = canvasWidth / 2;
            currentPosition.y = canvasHeight / 2;
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç—ã –∏ —Å—Ç—Ä–µ–ª–∫–∏
        function drawMap() {
            const canvasWidth = mapCanvas.width / (window.devicePixelRatio || 1);
            const canvasHeight = mapCanvas.height / (window.devicePixelRatio || 1);
            
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            
            if (mapImage) {
                ctx.drawImage(
                    mapImage,
                    mapOffset.x, mapOffset.y,
                    mapImage.width * mapScale,
                    mapImage.height * mapScale
                );
            } else {
                // –†–∏—Å—É–µ–º placeholder
                ctx.fillStyle = '#2c3e50';
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);
                
                ctx.fillStyle = '#34495e';
                ctx.font = '20px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–∞—Ä—Ç—É', canvasWidth / 2, canvasHeight / 2);
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Å—Ç—Ä–µ–ª–∫–∏
            updateArrowPosition();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Å—Ç—Ä–µ–ª–∫–∏
        function updateArrowPosition() {
            arrow.style.left = `${currentPosition.x}px`;
            arrow.style.top = `${currentPosition.y}px`;
            
            // –ü–æ–≤–æ—Ä–æ—Ç —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≥–∏—Ä–æ—Å–∫–æ–ø–∞
            const rotation = smoothedGamma;
            arrow.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
            posXElement.textContent = Math.round(currentPosition.x);
            posYElement.textContent = Math.round(currentPosition.y);
            headingElement.textContent = `${Math.round(rotation)}¬∞`;
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–∏—Ä–æ—Å–∫–æ–ø–∞
        function handleOrientation(event) {
            if (!event.absolute) return;
            
            alpha = event.alpha; // –ö–æ–º–ø–∞—Å
            beta = event.beta;   // –ù–∞–∫–ª–æ–Ω –≤–ø–µ—Ä–µ–¥/–Ω–∞–∑–∞–¥
            gamma = event.gamma; // –ù–∞–∫–ª–æ–Ω –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ
            
            // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π
            smoothedGamma = smoothedGamma * 0.7 + gamma * 0.3;
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —É–≥–ª–∞
            smoothedGamma = Math.max(-90, Math.min(90, smoothedGamma));
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–µ–ª–∫–∏
            updateArrowPosition();
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–∞
        function handleMotion(event) {
            if (!event.accelerationIncludingGravity) return;
            
            const accel = event.accelerationIncludingGravity;
            
            // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ —É—Å–∫–æ—Ä–µ–Ω–∏—è
            const smoothX = lastAcceleration.x * 0.8 + accel.x * 0.2;
            const smoothY = lastAcceleration.y * 0.8 + accel.y * 0.2;
            
            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —à—É–º–∞
            const threshold = 0.5;
            let movement = 0;
            
            if (Math.abs(smoothX) > threshold || Math.abs(smoothY) > threshold) {
                movement = Math.sqrt(smoothX * smoothX + smoothY * smoothY) - threshold;
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–µ–ª–∫–∏
                const angleRad = (smoothedGamma * Math.PI) / 180;
                const moveForward = -smoothY * Math.cos(angleRad) + smoothX * Math.sin(angleRad);
                const moveSide = smoothX * Math.cos(angleRad) + smoothY * Math.sin(angleRad);
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Å —É—á–µ—Ç–æ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                const sensitivity = movementSensitivity / 10;
                currentPosition.x += moveForward * sensitivity;
                currentPosition.y += moveSide * sensitivity;
                
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∫–∞—Ä—Ç—ã
                if (mapImage) {
                    const minX = mapOffset.x + 20;
                    const maxX = mapOffset.x + mapImage.width * mapScale - 20;
                    const minY = mapOffset.y + 20;
                    const maxY = mapOffset.y + mapImage.height * mapScale - 20;
                    
                    currentPosition.x = Math.max(minX, Math.min(maxX, currentPosition.x));
                    currentPosition.y = Math.max(minY, Math.min(maxY, currentPosition.y));
                } else {
                    const canvasWidth = mapCanvas.width / (window.devicePixelRatio || 1);
                    const canvasHeight = mapCanvas.height / (window.devicePixelRatio || 1);
                    
                    currentPosition.x = Math.max(20, Math.min(canvasWidth - 20, currentPosition.x));
                    currentPosition.y = Math.max(20, Math.min(canvasHeight - 20, currentPosition.y));
                }
                
                drawMap();
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è
            movementElement.textContent = movement.toFixed(2);
            lastAcceleration = { x: smoothX, y: smoothY, z: accel.z };
        }
        
        // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã
        function startDrag(e) {
            isDragging = true;
            const rect = mapCanvas.getBoundingClientRect();
            
            if (e.type === 'touchstart') {
                dragStart.x = e.touches[0].clientX - rect.left;
                dragStart.y = e.touches[0].clientY - rect.top;
            } else {
                dragStart.x = e.clientX - rect.left;
                dragStart.y = e.clientY - rect.top;
            }
            
            lastOffset = { ...mapOffset };
            mapCanvas.style.cursor = 'grabbing';
        }
        
        function drag(e) {
            if (!isDragging || !mapImage) return;
            
            e.preventDefault();
            const rect = mapCanvas.getBoundingClientRect();
            let clientX, clientY;
            
            if (e.type === 'touchmove') {
                clientX = e.touches[0].clientX - rect.left;
                clientY = e.touches[0].clientY - rect.top;
            } else {
                clientX = e.clientX - rect.left;
                clientY = e.clientY - rect.top;
            }
            
            const deltaX = clientX - dragStart.x;
            const deltaY = clientY - dragStart.y;
            
            mapOffset.x = lastOffset.x + deltaX;
            mapOffset.y = lastOffset.y + deltaY;
            
            drawMap();
        }
        
        function endDrag() {
            isDragging = false;
            mapCanvas.style.cursor = 'grab';
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function updateStatus(message) {
            statusText.textContent = message;
        }
        
        function hideInstructions() {
            instructions.style.display = 'none';
            localStorage.setItem('instructionsShown', 'true');
        }
        
        function toggleCalibration() {
            calibrationPanel.classList.toggle('hidden');
        }
        
        function calibrateSensors() {
            isCalibrating = true;
            updateStatus('–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞... –î–µ—Ä–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ');
            
            setTimeout(() => {
                calibrationOffset.x = lastAcceleration.x;
                calibrationOffset.y = lastAcceleration.y;
                isCalibrating = false;
                calibrationPanel.classList.add('hidden');
                updateStatus('–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
            }, 3000);
        }
        
        function resetPosition() {
            centerMap();
            drawMap();
            updateStatus('–ü–æ–∑–∏—Ü–∏—è —Å–±—Ä–æ—à–µ–Ω–∞');
        }
        
        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        window.addEventListener('load', init);
        
        // –î–ª—è iOS Web App
        window.addEventListener('orientationchange', resizeCanvas);
    </script>
</body>
</html>