<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>üìç –ù–∞–≤–∏–≥–∞—Ç–æ—Ä —Å –∞–≤—Ç–æ-–¥–≤–∏–∂–µ–Ω–∏–µ–º</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* iOS-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ —Å—Ç–∏–ª–∏ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }

        html {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #000;
            color: white;
            height: 100vh;
            height: -webkit-fill-available;
            width: 100vw;
            overflow: hidden;
            position: fixed;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: none;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
            width: 100vw;
            background: #000;
            position: relative;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä–∞ */
        .nav-header {
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        .nav-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #007AFF, #5856D6);
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .nav-text h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .nav-text p {
            font-size: 13px;
            opacity: 0.7;
            margin-top: 2px;
        }

        /* –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã */
        .nav-upload-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-upload-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.95);
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #000;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã */
        .map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            overflow: hidden;
            touch-action: none;
        }

        #mapCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
            background: #000;
        }

        /* –•–æ–ª—Å—Ç –¥–ª—è —Å–ª–µ–¥–∞ */
        .arrow-trail {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 90;
            pointer-events: none;
        }

        #trailCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }

        /* –°—Ç—Ä–µ–ª–∫–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è */
        .location-arrow {
            position: absolute;
            width: 60px;
            height: 60px;
            z-index: 100;
            pointer-events: none;
            filter: drop-shadow(0 0 10px rgba(0, 122, 255, 0.5));
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }

        .arrow-icon {
            width: 100%;
            height: 100%;
        }

        /* –ü–∞–Ω–µ–ª—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç */
        .coordinates-panel {
            position: absolute;
            bottom: 120px;
            left: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 16px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 50;
        }

        .coord-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .coord-label {
            opacity: 0.7;
        }

        .coord-value {
            font-family: 'Menlo', 'Monaco', monospace;
            font-weight: 600;
            color: #007AFF;
        }

        /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .control-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 12px;
            z-index: 100;
        }

        .control-btn {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 12px;
            padding: 14px;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-touch-callout: none;
            user-select: none;
        }

        .control-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.95);
        }

        .control-btn i {
            font-size: 22px;
        }

        .control-btn span {
            font-size: 12px;
            font-weight: 500;
        }

        .control-btn.active {
            background: linear-gradient(135deg, #007AFF, #5856D6);
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã */
        .indicators {
            position: absolute;
            top: 16px;
            left: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 50;
        }

        .indicator {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .indicator i {
            font-size: 16px;
        }

        .indicator.good i { color: #34C759; }
        .indicator.warning i { color: #FF9500; }
        .indicator.error i { color: #FF3B30; }

        .indicator span {
            opacity: 0.9;
        }

        /* –ú–∞—Å—à—Ç–∞–± */
        .zoom-controls {
            position: absolute;
            right: 16px;
            bottom: 200px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 50;
        }

        .zoom-btn {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .zoom-btn:active {
            background: rgba(255, 255, 255, 0.1);
        }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è */
        .movement-settings {
            position: absolute;
            top: 100px;
            left: 16px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            z-index: 50;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-size: 14px;
        }

        .setting-label {
            opacity: 0.8;
        }

        .setting-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            padding: 4px 8px;
            width: 60px;
            text-align: center;
            font-size: 14px;
        }

        .setting-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .setting-btn.active {
            background: rgba(0, 122, 255, 0.5);
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 14px 20px;
            border-radius: 14px;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 300px;
            width: auto;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .notification i {
            font-size: 18px;
        }

        .notification.success i { color: #34C759; }
        .notification.error i { color: #FF3B30; }
        .notification.warning i { color: #FF9500; }

        /* –ó–∞–≥—Ä—É–∑—á–∏–∫ */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .loader.show {
            opacity: 1;
            pointer-events: all;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-height: 700px) {
            .coordinates-panel {
                bottom: 100px;
                padding: 12px;
            }
            
            .control-panel {
                padding: 12px;
            }
            
            .control-btn {
                padding: 12px;
            }
        }

        @media (max-width: 400px) {
            .control-btn span {
                font-size: 11px;
            }
            
            .coordinates-panel {
                left: 8px;
                right: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
        <div class="nav-header">
            <div class="nav-title">
                <div class="nav-icon">
                    <i class="fas fa-location-arrow"></i>
                </div>
                <div class="nav-text">
                    <h1>–ù–∞–≤–∏–≥–∞—Ç–æ—Ä</h1>
                    <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Å—Ç—Ä–µ–ª–∫–∏</p>
                </div>
            </div>
            <button class="nav-upload-btn" id="navUploadBtn" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É">
                <i class="fas fa-map"></i>
            </button>
            <input type="file" id="mapUpload" accept="image/*" style="display: none;">
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
        <div class="main-content">
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã -->
            <div class="map-container" id="mapContainer">
                <canvas id="mapCanvas"></canvas>
                <!-- –•–æ–ª—Å—Ç –¥–ª—è —Å–ª–µ–¥–∞ -->
                <div class="arrow-trail">
                    <canvas id="trailCanvas"></canvas>
                </div>
                
                <!-- –°—Ç—Ä–µ–ª–∫–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è -->
                <div class="location-arrow" id="locationArrow">
                    <svg class="arrow-icon" viewBox="0 0 100 100">
                        <defs>
                            <radialGradient id="arrowGrad" cx="50%" cy="50%">
                                <stop offset="0%" stop-color="#007AFF"/>
                                <stop offset="100%" stop-color="#0056CC"/>
                            </radialGradient>
                            <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                                <feGaussianBlur stdDeviation="3" result="blur"/>
                                <feMerge>
                                    <feMergeNode in="blur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        <path d="M50 15 L60 50 L50 85 L40 50 Z" 
                              fill="url(#arrowGrad)" 
                              stroke="#FFFFFF" 
                              stroke-width="2"
                              filter="url(#glow)"/>
                        <circle cx="50" cy="50" r="12" fill="#FFFFFF" opacity="0.3"/>
                        <circle cx="50" cy="50" r="6" fill="#FFFFFF"/>
                    </svg>
                </div>
            </div>

            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã -->
            <div class="indicators">
                <div class="indicator" id="motionIndicator">
                    <i class="fas fa-running"></i>
                    <span>–î–≤–∏–∂–µ–Ω–∏–µ: –≤—ã–∫–ª</span>
                </div>
                <div class="indicator" id="speedIndicator">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>–°–∫–æ—Ä–æ—Å—Ç—å: 0 –∫–º/—á</span>
                </div>
            </div>

            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è -->
            <div class="movement-settings" id="movementSettings">
                <div class="setting-item">
                    <span class="setting-label">–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</span>
                    <input type="number" id="sensitivity" class="setting-input" value="1.0" min="0.1" max="10" step="0.1">
                </div>
                <div class="setting-item">
                    <span class="setting-label">–°–ª–µ–¥:</span>
                    <button class="setting-btn" id="toggleTrail">
                        –≤–∫–ª
                    </button>
                </div>
                <div class="setting-item">
                    <span class="setting-label">–ê–≤—Ç–æ—Ü–µ–Ω—Ç—Ä:</span>
                    <button class="setting-btn" id="toggleAutoCenter">
                        –≤–∫–ª
                    </button>
                </div>
            </div>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–æ–º -->
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomIn">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="zoom-btn" id="zoomOut">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="zoom-btn" id="resetView">
                    <i class="fas fa-crosshairs"></i>
                </button>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
            <div class="coordinates-panel">
                <div class="coord-row">
                    <span class="coord-label">–ü–æ–∑–∏—Ü–∏—è X:</span>
                    <span class="coord-value" id="posX">0</span>
                </div>
                <div class="coord-row">
                    <span class="coord-label">–ü–æ–∑–∏—Ü–∏—è Y:</span>
                    <span class="coord-value" id="posY">0</span>
                </div>
                <div class="coord-row">
                    <span class="coord-label">–ü—Ä–æ–π–¥–µ–Ω–æ:</span>
                    <span class="coord-value" id="distance">0 –º</span>
                </div>
                <div class="coord-row">
                    <span class="coord-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</span>
                    <span class="coord-value" id="heading">0¬∞ (–°)</span>
                </div>
            </div>
        </div>

        <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="control-panel">
            <button class="control-btn active" id="startMotionBtn">
                <i class="fas fa-play"></i>
                <span>–°—Ç–∞—Ä—Ç</span>
            </button>
            <button class="control-btn" id="calibrateBtn">
                <i class="fas fa-compass"></i>
                <span>–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞</span>
            </button>
            <button class="control-btn" id="clearTrailBtn">
                <i class="fas fa-trash"></i>
                <span>–û—á–∏—Å—Ç–∏—Ç—å</span>
            </button>
            <button class="control-btn" id="saveBtn">
                <i class="fas fa-save"></i>
                <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
            </button>
        </div>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div class="notification" id="notification">
            <i class="fas fa-info-circle"></i>
            <span id="notificationText">–°–æ–æ–±—â–µ–Ω–∏–µ</span>
        </div>

        <!-- –ó–∞–≥—Ä—É–∑—á–∏–∫ -->
        <div class="loader" id="loader">
            <div class="spinner"></div>
        </div>
    </div>

    <script>
        // –ö–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –¥–≤–∏–∂–µ–Ω–∏–µ–º —Å—Ç—Ä–µ–ª–∫–∏ –ø–æ –¥–∞—Ç—á–∏–∫–∞–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        class AutoNavigator {
            constructor() {
                this.canvas = document.getElementById('mapCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.trailCanvas = document.getElementById('trailCanvas');
                this.trailCtx = this.trailCanvas.getContext('2d');
                this.locationArrow = document.getElementById('locationArrow');
                
                this.userImage = null;
                this.imagePosition = { x: 0, y: 0 };
                this.scale = 1;
                this.minScale = 0.1;
                this.maxScale = 3;
                
                // –ü–æ–∑–∏—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
                this.arrowPosition = { x: 0, y: 0 };
                this.trailPoints = [];
                this.trailEnabled = true;
                this.autoCenter = true;
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è
                this.sensitivity = 1.0; // –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                this.isMoving = false; // —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è
                this.motionActive = false; // —Ñ–ª–∞–≥ –≤–∫–ª—é—á–µ–Ω–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è
                
                // –î–∞–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–æ–≤
                this.lastAcceleration = { x: 0, y: 0, z: 0 };
                this.lastRotation = { alpha: 0, beta: 0, gamma: 0 };
                this.lastHeading = 0; // –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö
                this.lastSpeed = 0; // —Å–∫–æ—Ä–æ—Å—Ç—å –≤ –ø–∏–∫—Å–µ–ª—è—Ö/—Å–µ–∫
                
                // –ò—Å—Ç–æ—Ä–∏—è –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
                this.accelerationHistory = [];
                this.rotationHistory = [];
                this.historySize = 5;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                this.totalDistance = 0; // –æ–±—â–µ–µ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
                this.lastUpdateTime = 0;
                
                this.init();
            }
            
            init() {
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => this.resizeCanvas(), 100);
                });
                
                this.setupEventListeners();
                this.centerArrow();
                this.showNotification('–ù–∞–≤–∏–≥–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω. –ù–∞–∂–º–∏—Ç–µ "–°—Ç–∞—Ä—Ç" –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è.', 'info', 5000);
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
                this.loadSettings();
            }
            
            resizeCanvas() {
                const container = document.getElementById('mapContainer');
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
                this.trailCanvas.width = container.clientWidth;
                this.trailCanvas.height = container.clientHeight;
                
                if (this.userImage) {
                    this.centerImage();
                } else {
                    this.drawWelcomeScreen();
                }
                
                this.drawTrail();
            }
            
            drawWelcomeScreen() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // –§–æ–Ω
                const gradient = this.ctx.createLinearGradient(0, 0, this.canvas.width, this.canvas.height);
                gradient.addColorStop(0, '#000000');
                gradient.addColorStop(1, '#1a1a2e');
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // –ò–∫–æ–Ω–∫–∞ –∏ —Ç–µ–∫—Å—Ç
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                this.ctx.font = 'bold 24px -apple-system, BlinkMacSystemFont';
                this.ctx.fillStyle = '#FFFFFF';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('–ù–∞–≤–∏–≥–∞—Ç–æ—Ä —Å –∞–≤—Ç–æ-–¥–≤–∏–∂–µ–Ω–∏–µ–º', centerX, centerY);
                
                // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
                this.ctx.font = '16px -apple-system, BlinkMacSystemFont';
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                this.ctx.fillText('–°—Ç—Ä–µ–ª–∫–∞ –¥–≤–∏–≥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏', centerX, centerY + 40);
                this.ctx.fillText('–ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –≤ —Ä—É–∫–∞—Ö', centerX, centerY + 70);
            }
            
            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                if (this.userImage) {
                    this.ctx.save();
                    this.ctx.translate(this.imagePosition.x, this.imagePosition.y);
                    this.ctx.scale(this.scale, this.scale);
                    this.ctx.drawImage(this.userImage, 0, 0);
                    this.ctx.restore();
                    
                    this.drawGrid();
                } else {
                    this.drawWelcomeScreen();
                }
                
                this.updatePositionDisplay();
            }
            
            drawGrid() {
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
                this.ctx.lineWidth = 1;
                
                const gridSize = 50 * this.scale;
                const offsetX = this.imagePosition.x % gridSize;
                const offsetY = this.imagePosition.y % gridSize;
                
                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
                for (let x = -offsetX; x < this.canvas.width; x += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x, this.canvas.height);
                    this.ctx.stroke();
                }
                
                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
                for (let y = -offsetY; y < this.canvas.height; y += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y);
                    this.ctx.lineTo(this.canvas.width, y);
                    this.ctx.stroke();
                }
                
                // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫—Ä–µ—Å—Ç
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                
                this.ctx.strokeStyle = 'rgba(255, 0, 0, 0.3)';
                this.ctx.lineWidth = 2;
                
                this.ctx.beginPath();
                this.ctx.moveTo(centerX - 15, centerY);
                this.ctx.lineTo(centerX + 15, centerY);
                this.ctx.moveTo(centerX, centerY - 15);
                this.ctx.lineTo(centerX, centerY + 15);
                this.ctx.stroke();
            }
            
            drawTrail() {
                if (!this.trailEnabled || this.trailPoints.length < 2) {
                    this.trailCtx.clearRect(0, 0, this.trailCanvas.width, this.trailCanvas.height);
                    return;
                }
                
                this.trailCtx.clearRect(0, 0, this.trailCanvas.width, this.trailCanvas.height);
                
                // –†–∏—Å—É–µ–º –ø—É—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è
                this.trailCtx.strokeStyle = 'rgba(0, 122, 255, 0.5)';
                this.trailCtx.lineWidth = 3;
                this.trailCtx.lineCap = 'round';
                this.trailCtx.lineJoin = 'round';
                
                this.trailCtx.beginPath();
                
                for (let i = 0; i < this.trailPoints.length; i++) {
                    const point = this.trailPoints[i];
                    const screenX = point.x * this.scale + this.imagePosition.x;
                    const screenY = point.y * this.scale + this.imagePosition.y;
                    
                    if (i === 0) {
                        this.trailCtx.moveTo(screenX, screenY);
                    } else {
                        this.trailCtx.lineTo(screenX, screenY);
                    }
                }
                
                this.trailCtx.stroke();
                
                // –†–∏—Å—É–µ–º —Ç–æ—á–∫–∏ –ø—É—Ç–∏
                this.trailCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                for (let i = 0; i < this.trailPoints.length; i += 10) {
                    const point = this.trailPoints[i];
                    const screenX = point.x * this.scale + this.imagePosition.x;
                    const screenY = point.y * this.scale + this.imagePosition.y;
                    
                    this.trailCtx.beginPath();
                    this.trailCtx.arc(screenX, screenY, 3, 0, Math.PI * 2);
                    this.trailCtx.fill();
                }
            }
            
            centerArrow() {
                this.arrowPosition.x = this.canvas.width / 2;
                this.arrowPosition.y = this.canvas.height / 2;
                this.updateArrowPosition();
            }
            
            updateArrowPosition() {
                this.locationArrow.style.left = `${this.arrowPosition.x}px`;
                this.locationArrow.style.top = `${this.arrowPosition.y}px`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É –≤ –ø—É—Ç—å
                if (this.trailEnabled) {
                    const mapX = (this.arrowPosition.x - this.imagePosition.x) / this.scale;
                    const mapY = (this.arrowPosition.y - this.imagePosition.y) / this.scale;
                    
                    this.trailPoints.push({ x: mapX, y: mapY });
                    
                    if (this.trailPoints.length > 1000) {
                        this.trailPoints.shift();
                    }
                    
                    this.drawTrail();
                }
            }
            
            loadImage(file) {
                if (!file.type.match('image.*')) {
                    this.showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
                    return;
                }
                
                this.showLoader();
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        this.userImage = img;
                        this.centerImage();
                        this.showNotification(`–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞: ${file.name}`, 'success');
                        this.hideLoader();
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                        localStorage.setItem('lastMap', e.target.result);
                        localStorage.setItem('lastMapName', file.name);
                        
                        // –û—á–∏—â–∞–µ–º –ø—É—Ç—å
                        this.trailPoints = [];
                        this.drawTrail();
                        this.centerArrow();
                    };
                    img.onerror = () => {
                        this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
                        this.hideLoader();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            centerImage() {
                if (!this.userImage) return;
                
                this.imagePosition.x = (this.canvas.width - this.userImage.width * this.scale) / 2;
                this.imagePosition.y = (this.canvas.height - this.userImage.height * this.scale) / 2;
                this.draw();
                this.drawTrail();
            }
            
            zoomIn() {
                if (this.scale < this.maxScale) {
                    this.scale *= 1.2;
                    this.adjustZoomPosition(1.2);
                    this.draw();
                    this.drawTrail();
                }
            }
            
            zoomOut() {
                if (this.scale > this.minScale) {
                    this.scale /= 1.2;
                    this.adjustZoomPosition(1/1.2);
                    this.draw();
                    this.drawTrail();
                }
            }
            
            adjustZoomPosition(factor) {
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                
                this.imagePosition.x = centerX - (centerX - this.imagePosition.x) * factor;
                this.imagePosition.y = centerY - (centerY - this.imagePosition.y) * factor;
            }
            
            resetView() {
                this.scale = 1;
                this.centerImage();
                if (this.autoCenter) {
                    this.centerArrow();
                }
                this.showNotification('–í–∏–¥ —Å–±—Ä–æ—à–µ–Ω', 'info');
            }
            
            // ===== –û–°–ù–û–í–ù–û–ô –ú–ï–¢–û–î: –û–ë–†–ê–ë–û–¢–ö–ê –î–í–ò–ñ–ï–ù–ò–Ø –ü–û –î–ê–¢–ß–ò–ö–ê–ú =====
            
            startMotionTracking() {
                if (!this.motionActive) {
                    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –¥–∞—Ç—á–∏–∫–∞–º –¥–≤–∏–∂–µ–Ω–∏—è
                    if (typeof DeviceMotionEvent !== 'undefined' && 
                        typeof DeviceMotionEvent.requestPermission === 'function') {
                        
                        DeviceMotionEvent.requestPermission()
                            .then(permissionState => {
                                if (permissionState === 'granted') {
                                    this.enableMotionTracking();
                                } else {
                                    this.showNotification('–î–æ—Å—Ç—É–ø –∫ –¥–∞—Ç—á–∏–∫–∞–º –¥–≤–∏–∂–µ–Ω–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω', 'error');
                                }
                            })
                            .catch(error => {
                                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–æ—Å—Ç—É–ø–∞:', error);
                                this.showNotification('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞—Ç—á–∏–∫–∞–º', 'error');
                            });
                    } else {
                        this.enableMotionTracking();
                    }
                } else {
                    this.disableMotionTracking();
                }
            }
            
            enableMotionTracking() {
                this.motionActive = true;
                this.lastUpdateTime = Date.now();
                
                // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–∞ –∏ –≥–∏—Ä–æ—Å–∫–æ–ø–∞
                window.addEventListener('devicemotion', this.handleDeviceMotion.bind(this));
                window.addEventListener('deviceorientation', this.handleDeviceOrientation.bind(this));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                document.getElementById('startMotionBtn').classList.add('active');
                document.getElementById('startMotionBtn').innerHTML = '<i class="fas fa-stop"></i><span>–°—Ç–æ–ø</span>';
                document.getElementById('motionIndicator').className = 'indicator good';
                document.getElementById('motionIndicator').innerHTML = '<i class="fas fa-running"></i><span>–î–≤–∏–∂–µ–Ω–∏–µ: –∞–∫—Ç–∏–≤–Ω–æ</span>';
                
                this.showNotification('–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω–æ. –î–≤–∏–≥–∞–π—Ç–µ—Å—å —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –≤ —Ä—É–∫–∞—Ö.', 'success');
            }
            
            disableMotionTracking() {
                this.motionActive = false;
                this.isMoving = false;
                
                // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                window.removeEventListener('devicemotion', this.handleDeviceMotion.bind(this));
                window.removeEventListener('deviceorientation', this.handleDeviceOrientation.bind(this));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                document.getElementById('startMotionBtn').classList.remove('active');
                document.getElementById('startMotionBtn').innerHTML = '<i class="fas fa-play"></i><span>–°—Ç–∞—Ä—Ç</span>';
                document.getElementById('motionIndicator').className = 'indicator';
                document.getElementById('motionIndicator').innerHTML = '<i class="fas fa-running"></i><span>–î–≤–∏–∂–µ–Ω–∏–µ: –≤—ã–∫–ª</span>';
                document.getElementById('speedIndicator').innerHTML = '<i class="fas fa-tachometer-alt"></i><span>–°–∫–æ—Ä–æ—Å—Ç—å: 0 –∫–º/—á</span>';
                
                this.showNotification('–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω–æ', 'info');
            }
            
            handleDeviceMotion(event) {
                if (!this.motionActive || !this.userImage) return;
                
                const acceleration = event.accelerationIncludingGravity || 
                                    event.acceleration || 
                                    { x: 0, y: 0, z: 0 };
                
                // –í—Ä–µ–º—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                const now = Date.now();
                const deltaTime = (now - this.lastUpdateTime) / 1000; // –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
                this.lastUpdateTime = now;
                
                if (deltaTime <= 0) return;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
                this.accelerationHistory.push({
                    x: acceleration.x || 0,
                    y: acceleration.y || 0,
                    z: acceleration.z || 0,
                    timestamp: now
                });
                
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
                const maxAge = 1000; // 1 —Å–µ–∫—É–Ω–¥–∞
                this.accelerationHistory = this.accelerationHistory.filter(
                    data => now - data.timestamp < maxAge
                );
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ
                const avgAccel = this.calculateAverageAcceleration();
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –¥–≤–∏–∂–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–∫–æ—Ä–µ–Ω–∏—è)
                const movementThreshold = 0.3; // –ø–æ—Ä–æ–≥ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è
                const accelerationChange = Math.abs(avgAccel.x - this.lastAcceleration.x) +
                                          Math.abs(avgAccel.y - this.lastAcceleration.y) +
                                          Math.abs(avgAccel.z - this.lastAcceleration.z);
                
                this.isMoving = accelerationChange > movementThreshold;
                
                // –ï—Å–ª–∏ –¥–≤–∏–∂–µ–º—Å—è - –≤—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ
                if (this.isMoving) {
                    // –í—ã—á–∏—Å–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Å–∫–æ—Ä–µ–Ω–∏—è
                    const speedFactor = 50 * this.sensitivity; // –±–∞–∑–æ–≤—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
                    const currentSpeed = accelerationChange * speedFactor * deltaTime;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∫–æ—Ä–æ—Å—Ç–∏
                    const speedKmh = (currentSpeed * 3.6).toFixed(1);
                    document.getElementById('speedIndicator').innerHTML = 
                        `<i class="fas fa-tachometer-alt"></i><span>–°–∫–æ—Ä–æ—Å—Ç—å: ${speedKmh} –∫–º/—á</span>`;
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Å–∫–æ—Ä–µ–Ω–∏—è –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                    this.calculateAndApplyMovement(avgAccel, currentSpeed, deltaTime);
                } else {
                    document.getElementById('speedIndicator').innerHTML = 
                        '<i class="fas fa-tachometer-alt"></i><span>–°–∫–æ—Ä–æ—Å—Ç—å: 0 –∫–º/—á</span>';
                }
                
                this.lastAcceleration = avgAccel;
            }
            
            calculateAverageAcceleration() {
                if (this.accelerationHistory.length === 0) {
                    return { x: 0, y: 0, z: 0 };
                }
                
                let sumX = 0, sumY = 0, sumZ = 0;
                for (const accel of this.accelerationHistory) {
                    sumX += accel.x;
                    sumY += accel.y;
                    sumZ += accel.z;
                }
                
                return {
                    x: sumX / this.accelerationHistory.length,
                    y: sumY / this.accelerationHistory.length,
                    z: sumZ / this.accelerationHistory.length
                };
            }
            
            handleDeviceOrientation(event) {
                if (!this.motionActive) return;
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞—Å–∞
                if (event.alpha !== null) {
                    this.lastHeading = event.alpha;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–µ–ª–∫–∏
                    this.locationArrow.style.transform = `translate(-50%, -50%) rotate(${this.lastHeading}deg)`;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                    this.updateHeadingDisplay(this.lastHeading);
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –Ω–∞–∫–ª–æ–Ω–∞
                if (event.beta !== null && event.gamma !== null) {
                    this.rotationHistory.push({
                        beta: event.beta,
                        gamma: event.gamma,
                        timestamp: Date.now()
                    });
                    
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
                    const now = Date.now();
                    this.rotationHistory = this.rotationHistory.filter(
                        data => now - data.timestamp < 1000
                    );
                }
            }
            
            calculateAndApplyMovement(acceleration, speed, deltaTime) {
                // –ü–æ–ª—É—á–∞–µ–º —Å—Ä–µ–¥–Ω–∏–π –Ω–∞–∫–ª–æ–Ω —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                const avgTilt = this.calculateAverageTilt();
                
                // –í—ã—á–∏—Å–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–º–ø–∞—Å–∞ –∏ –Ω–∞–∫–ª–æ–Ω–∞
                let moveAngle = this.lastHeading;
                
                // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —É–≥–æ–ª –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∫–ª–æ–Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                if (avgTilt.gamma !== 0) {
                    // –ï—Å–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–∞–∫–ª–æ–Ω–µ–Ω –≤ —Å—Ç–æ—Ä–æ–Ω—É, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                    const tiltFactor = avgTilt.gamma / 90; // -1 –¥–æ +1
                    moveAngle += tiltFactor * 30; // –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –¥–æ 30 –≥—Ä–∞–¥—É—Å–æ–≤
                }
                
                // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —É–≥–æ–ª
                moveAngle = (moveAngle + 360) % 360;
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
                const distance = speed * 10 * this.sensitivity; // —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
                const angleRad = moveAngle * Math.PI / 180;
                
                const deltaX = Math.sin(angleRad) * distance;
                const deltaY = -Math.cos(angleRad) * distance; // –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Y (—ç–∫—Ä–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å—Ç—Ä–µ–ª–∫–∏
                this.arrowPosition.x += deltaX;
                this.arrowPosition.y += deltaY;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–µ–µ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
                this.totalDistance += Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
                const padding = 50;
                this.arrowPosition.x = Math.max(padding, Math.min(this.canvas.width - padding, this.arrowPosition.x));
                this.arrowPosition.y = Math.max(padding, Math.min(this.canvas.height - padding, this.arrowPosition.y));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                this.updateArrowPosition();
                this.scrollMapIfNeeded();
                this.updatePositionDisplay();
            }
            
            calculateAverageTilt() {
                if (this.rotationHistory.length === 0) {
                    return { beta: 0, gamma: 0 };
                }
                
                let sumBeta = 0, sumGamma = 0;
                for (const rot of this.rotationHistory) {
                    sumBeta += rot.beta;
                    sumGamma += rot.gamma;
                }
                
                return {
                    beta: sumBeta / this.rotationHistory.length,
                    gamma: sumGamma / this.rotationHistory.length
                };
            }
            
            updateHeadingDisplay(heading) {
                const directions = ['–°', '–°–í', '–í', '–Æ–í', '–Æ', '–Æ–ó', '–ó', '–°–ó'];
                const index = Math.round((heading % 360) / 45) % 8;
                document.getElementById('heading').textContent = `${Math.round(heading)}¬∞ (${directions[index]})`;
            }
            
            scrollMapIfNeeded() {
                if (!this.userImage) return;
                
                const threshold = 100; // —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –∫—Ä–∞—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                const scrollSpeed = 5;
                
                let needsRedraw = false;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∞—è
                if (this.arrowPosition.x < threshold) {
                    this.imagePosition.x += scrollSpeed;
                    needsRedraw = true;
                } else if (this.arrowPosition.x > this.canvas.width - threshold) {
                    this.imagePosition.x -= scrollSpeed;
                    needsRedraw = true;
                }
                
                if (this.arrowPosition.y < threshold) {
                    this.imagePosition.y += scrollSpeed;
                    needsRedraw = true;
                } else if (this.arrowPosition.y > this.canvas.height - threshold) {
                    this.imagePosition.y -= scrollSpeed;
                    needsRedraw = true;
                }
                
                if (needsRedraw) {
                    this.draw();
                    this.drawTrail();
                }
            }
            
            updatePositionDisplay() {
                document.getElementById('posX').textContent = Math.round(this.arrowPosition.x);
                document.getElementById('posY').textContent = Math.round(this.arrowPosition.y);
                document.getElementById('distance').textContent = `${Math.round(this.totalDistance)} –º`;
            }
            
            calibrateMotion() {
                this.showNotification('–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞: –¥–µ—Ä–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –ø—Ä—è–º–æ –∏ –Ω–µ –¥–≤–∏–≥–∞–π—Ç–µ—Å—å 3 —Å–µ–∫—É–Ω–¥—ã', 'info', 3000);
                
                // –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
                this.accelerationHistory = [];
                this.rotationHistory = [];
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–∞–∫ –±–∞–∑–æ–≤—ã–µ
                setTimeout(() => {
                    if (this.accelerationHistory.length > 0) {
                        this.lastAcceleration = this.calculateAverageAcceleration();
                        this.showNotification('–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
                    }
                }, 3000);
            }
            
            clearTrail() {
                this.trailPoints = [];
                this.totalDistance = 0;
                this.drawTrail();
                this.updatePositionDisplay();
                this.showNotification('–ü—É—Ç—å –æ—á–∏—â–µ–Ω', 'info');
            }
            
            toggleTrail() {
                this.trailEnabled = !this.trailEnabled;
                const trailBtn = document.getElementById('toggleTrail');
                trailBtn.textContent = this.trailEnabled ? '–≤–∫–ª' : '–≤—ã–∫–ª';
                trailBtn.classList.toggle('active', this.trailEnabled);
                
                this.drawTrail();
                this.showNotification(`–°–ª–µ–¥ ${this.trailEnabled ? '–≤–∫–ª—é—á–µ–Ω' : '–≤—ã–∫–ª—é—á–µ–Ω'}`, 'info');
            }
            
            toggleAutoCenter() {
                this.autoCenter = !this.autoCenter;
                const centerBtn = document.getElementById('toggleAutoCenter');
                centerBtn.textContent = this.autoCenter ? '–≤–∫–ª' : '–≤—ã–∫–ª';
                centerBtn.classList.toggle('active', this.autoCenter);
                
                this.showNotification(`–ê–≤—Ç–æ—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ ${this.autoCenter ? '–≤–∫–ª—é—á–µ–Ω–æ' : '–≤—ã–∫–ª—é—á–µ–Ω–æ'}`, 'info');
            }
            
            saveSettings() {
                const settings = {
                    sensitivity: this.sensitivity,
                    trailEnabled: this.trailEnabled,
                    autoCenter: this.autoCenter,
                    arrowPosition: this.arrowPosition,
                    imagePosition: this.imagePosition,
                    scale: this.scale,
                    totalDistance: this.totalDistance,
                    trailPoints: this.trailPoints
                };
                
                localStorage.setItem('autoNavigatorSettings', JSON.stringify(settings));
                this.showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            }
            
            loadSettings() {
                const saved = localStorage.getItem('autoNavigatorSettings');
                if (saved) {
                    try {
                        const settings = JSON.parse(saved);
                        this.sensitivity = settings.sensitivity || 1.0;
                        this.trailEnabled = settings.trailEnabled !== false;
                        this.autoCenter = settings.autoCenter !== false;
                        this.arrowPosition = settings.arrowPosition || { x: this.canvas.width / 2, y: this.canvas.height / 2 };
                        this.imagePosition = settings.imagePosition || { x: 0, y: 0 };
                        this.scale = settings.scale || 1;
                        this.totalDistance = settings.totalDistance || 0;
                        this.trailPoints = settings.trailPoints || [];
                        
                        document.getElementById('sensitivity').value = this.sensitivity;
                        document.getElementById('toggleTrail').textContent = this.trailEnabled ? '–≤–∫–ª' : '–≤—ã–∫–ª';
                        document.getElementById('toggleTrail').classList.toggle('active', this.trailEnabled);
                        document.getElementById('toggleAutoCenter').textContent = this.autoCenter ? '–≤–∫–ª' : '–≤—ã–∫–ª';
                        document.getElementById('toggleAutoCenter').classList.toggle('active', this.autoCenter);
                        
                        this.updateArrowPosition();
                        this.draw();
                        this.drawTrail();
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', e);
                    }
                }
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–∞—Ä—Ç—ã
                const lastMap = localStorage.getItem('lastMap');
                if (lastMap) {
                    const img = new Image();
                    img.onload = () => {
                        this.userImage = img;
                        this.draw();
                        const mapName = localStorage.getItem('lastMapName') || '–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞';
                        this.showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–∞ ${mapName}`, 'info');
                    };
                    img.src = lastMap;
                }
            }
            
            showNotification(message, type = 'info', duration = 3000) {
                const notification = document.getElementById('notification');
                const text = document.getElementById('notificationText');
                
                notification.className = `notification ${type}`;
                text.textContent = message;
                
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, duration);
            }
            
            showLoader() {
                document.getElementById('loader').classList.add('show');
            }
            
            hideLoader() {
                document.getElementById('loader').classList.remove('show');
            }
            
            setupEventListeners() {
                // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã
                document.getElementById('navUploadBtn').addEventListener('click', () => {
                    document.getElementById('mapUpload').click();
                });
                
                document.getElementById('mapUpload').addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        this.loadImage(e.target.files[0]);
                    }
                });
                
                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏–µ–º
                document.getElementById('startMotionBtn').addEventListener('click', () => {
                    this.startMotionTracking();
                });
                
                document.getElementById('calibrateBtn').addEventListener('click', () => {
                    this.calibrateMotion();
                });
                
                document.getElementById('clearTrailBtn').addEventListener('click', () => {
                    this.clearTrail();
                });
                
                document.getElementById('saveBtn').addEventListener('click', () => {
                    this.saveSettings();
                });
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                document.getElementById('sensitivity').addEventListener('change', (e) => {
                    this.sensitivity = parseFloat(e.target.value) || 1.0;
                });
                
                document.getElementById('toggleTrail').addEventListener('click', () => {
                    this.toggleTrail();
                });
                
                document.getElementById('toggleAutoCenter').addEventListener('click', () => {
                    this.toggleAutoCenter();
                });
                
                // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
                document.getElementById('zoomIn').addEventListener('click', () => this.zoomIn());
                document.getElementById('zoomOut').addEventListener('click', () => this.zoomOut());
                document.getElementById('resetView').addEventListener('click', () => this.resetView());
                
                // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (this.userImage && e.touches.length === 1) {
                        const touch = e.touches[0];
                        this.imagePosition.x = touch.clientX - this.imagePosition.x;
                        this.imagePosition.y = touch.clientY - this.imagePosition.y;
                    }
                }, { passive: false });
                
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (this.userImage && e.touches.length === 1) {
                        const touch = e.touches[0];
                        this.imagePosition.x = touch.clientX - this.imagePosition.x;
                        this.imagePosition.y = touch.clientY - this.imagePosition.y;
                        this.draw();
                        this.drawTrail();
                    }
                }, { passive: false });
                
                // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∂–µ—Å—Ç–æ–º
                let initialDistance = 0;
                
                this.canvas.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 2 && this.userImage) {
                        initialDistance = Math.hypot(
                            e.touches[0].clientX - e.touches[1].clientX,
                            e.touches[0].clientY - e.touches[1].clientY
                        );
                    }
                });
                
                this.canvas.addEventListener('touchmove', (e) => {
                    if (e.touches.length === 2 && this.userImage && initialDistance > 0) {
                        e.preventDefault();
                        
                        const currentDistance = Math.hypot(
                            e.touches[0].clientX - e.touches[1].clientX,
                            e.touches[0].clientY - e.touches[1].clientY
                        );
                        
                        const delta = currentDistance - initialDistance;
                        if (Math.abs(delta) > 30) {
                            if (delta > 0) {
                                this.zoomIn();
                            } else {
                                this.zoomOut();
                            }
                            initialDistance = currentDistance;
                        }
                    }
                }, { passive: false });
                
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∂–µ—Å—Ç–æ–≤
                document.addEventListener('touchmove', (e) => {
                    if (e.target === this.canvas || e.target.closest('.map-container')) {
                        e.preventDefault();
                    }
                }, { passive: false });
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                window.navigator = new AutoNavigator();
            }, 100);
        });
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∂–µ—Å—Ç–æ–º –Ω–∞ iOS
        document.addEventListener('gesturestart', (e) => {
            e.preventDefault();
        });
    </script>
</body>
</html>