<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>üìç –ù–∞–≤–∏–≥–∞—Ç–æ—Ä —Å GPS-—Ç—Ä–µ–∫–∏–Ω–≥–æ–º</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* iOS-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ —Å—Ç–∏–ª–∏ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }

        html {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #000;
            color: white;
            height: 100vh;
            height: -webkit-fill-available;
            width: 100vw;
            overflow: hidden;
            position: fixed;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: none;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
            width: 100vw;
            background: #000;
            position: relative;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä–∞ */
        .nav-header {
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        .nav-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #007AFF, #5856D6);
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .nav-text h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .nav-text p {
            font-size: 13px;
            opacity: 0.7;
            margin-top: 2px;
        }

        /* –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã */
        .nav-upload-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-upload-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.95);
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #000;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã */
        .map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            overflow: hidden;
            touch-action: none;
        }

        #mapCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
            background: #000;
        }

        /* –•–æ–ª—Å—Ç –¥–ª—è —Å–ª–µ–¥–∞ */
        .arrow-trail {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 90;
            pointer-events: none;
        }

        #trailCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }

        /* –°—Ç—Ä–µ–ª–∫–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è */
        .location-arrow {
            position: absolute;
            width: 60px;
            height: 60px;
            z-index: 100;
            pointer-events: none;
            filter: drop-shadow(0 0 10px rgba(0, 122, 255, 0.5));
            transition: all 1s ease-out;
            transform: translate(-50%, -50%);
        }

        .arrow-icon {
            width: 100%;
            height: 100%;
        }

        /* –ü–∞–Ω–µ–ª—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç */
        .coordinates-panel {
            position: absolute;
            bottom: 120px;
            left: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 16px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 50;
        }

        .coord-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .coord-label {
            opacity: 0.7;
        }

        .coord-value {
            font-family: 'Menlo', 'Monaco', monospace;
            font-weight: 600;
            color: #007AFF;
        }

        /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .control-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 12px;
            z-index: 100;
        }

        .control-btn {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 12px;
            padding: 14px;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-touch-callout: none;
            user-select: none;
        }

        .control-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.95);
        }

        .control-btn i {
            font-size: 22px;
        }

        .control-btn span {
            font-size: 12px;
            font-weight: 500;
        }

        .control-btn.active {
            background: linear-gradient(135deg, #34C759, #28A745);
        }

        .control-btn.tracking {
            background: linear-gradient(135deg, #FF3B30, #D70015);
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã */
        .indicators {
            position: absolute;
            top: 16px;
            left: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 50;
        }

        .indicator {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .indicator i {
            font-size: 16px;
        }

        .indicator.good i { color: #34C759; }
        .indicator.warning i { color: #FF9500; }
        .indicator.error i { color: #FF3B30; }

        .indicator span {
            opacity: 0.9;
        }

        /* –ú–∞—Å—à—Ç–∞–± */
        .zoom-controls {
            position: absolute;
            right: 16px;
            bottom: 200px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 50;
        }

        .zoom-btn {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .zoom-btn:active {
            background: rgba(255, 255, 255, 0.1);
        }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ GPS */
        .gps-settings {
            position: absolute;
            top: 100px;
            left: 16px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            z-index: 50;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-size: 14px;
        }

        .setting-label {
            opacity: 0.8;
        }

        .setting-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            padding: 4px 8px;
            width: 60px;
            text-align: center;
            font-size: 14px;
        }

        .setting-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .setting-btn.active {
            background: rgba(0, 122, 255, 0.5);
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 14px 20px;
            border-radius: 14px;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 300px;
            width: auto;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .notification i {
            font-size: 18px;
        }

        .notification.success i { color: #34C759; }
        .notification.error i { color: #FF3B30; }
        .notification.warning i { color: #FF9500; }

        /* –ó–∞–≥—Ä—É–∑—á–∏–∫ */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .loader.show {
            opacity: 1;
            pointer-events: all;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes signal {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .signal {
            animation: signal 2s infinite;
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-height: 700px) {
            .coordinates-panel {
                bottom: 100px;
                padding: 12px;
            }
            
            .control-panel {
                padding: 12px;
            }
            
            .control-btn {
                padding: 12px;
            }
        }

        @media (max-width: 400px) {
            .control-btn span {
                font-size: 11px;
            }
            
            .coordinates-panel {
                left: 8px;
                right: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
        <div class="nav-header">
            <div class="nav-title">
                <div class="nav-icon">
                    <i class="fas fa-satellite"></i>
                </div>
                <div class="nav-text">
                    <h1>GPS –ù–∞–≤–∏–≥–∞—Ç–æ—Ä</h1>
                    <p>–°–ª–µ–∂–µ–Ω–∏–µ –∑–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ–º –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ</p>
                </div>
            </div>
            <button class="nav-upload-btn" id="navUploadBtn" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É">
                <i class="fas fa-map"></i>
            </button>
            <input type="file" id="mapUpload" accept="image/*" style="display: none;">
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
        <div class="main-content">
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã -->
            <div class="map-container" id="mapContainer">
                <canvas id="mapCanvas"></canvas>
                <!-- –•–æ–ª—Å—Ç –¥–ª—è —Å–ª–µ–¥–∞ -->
                <div class="arrow-trail">
                    <canvas id="trailCanvas"></canvas>
                </div>
                
                <!-- –°—Ç—Ä–µ–ª–∫–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è -->
                <div class="location-arrow" id="locationArrow">
                    <svg class="arrow-icon" viewBox="0 0 100 100">
                        <defs>
                            <radialGradient id="arrowGrad" cx="50%" cy="50%">
                                <stop offset="0%" stop-color="#34C759"/>
                                <stop offset="100%" stop-color="#28A745"/>
                            </radialGradient>
                            <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                                <feGaussianBlur stdDeviation="3" result="blur"/>
                                <feMerge>
                                    <feMergeNode in="blur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        <path d="M50 15 L60 50 L50 85 L40 50 Z" 
                              fill="url(#arrowGrad)" 
                              stroke="#FFFFFF" 
                              stroke-width="2"
                              filter="url(#glow)"/>
                        <circle cx="50" cy="50" r="12" fill="#FFFFFF" opacity="0.3"/>
                        <circle cx="50" cy="50" r="6" fill="#FFFFFF"/>
                    </svg>
                </div>
            </div>

            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã -->
            <div class="indicators">
                <div class="indicator" id="gpsStatus">
                    <i class="fas fa-satellite"></i>
                    <span>GPS: –ü–æ–∏—Å–∫ —Å–∏–≥–Ω–∞–ª–∞...</span>
                </div>
                <div class="indicator" id="accuracyStatus">
                    <i class="fas fa-bullseye"></i>
                    <span>–¢–æ—á–Ω–æ—Å—Ç—å: -- –º</span>
                </div>
            </div>

            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ GPS -->
            <div class="gps-settings" id="gpsSettings">
                <div class="setting-item">
                    <span class="setting-label">–ú–∞—Å—à—Ç–∞–± GPS:</span>
                    <input type="number" id="gpsScale" class="setting-input" value="1000" min="1" max="100000" step="100">
                </div>
                <div class="setting-item">
                    <span class="setting-label">–°–ª–µ–¥:</span>
                    <button class="setting-btn" id="toggleTrail">
                        –≤–∫–ª
                    </button>
                </div>
                <div class="setting-item">
                    <span class="setting-label">–ê–≤—Ç–æ—Ü–µ–Ω—Ç—Ä:</span>
                    <button class="setting-btn" id="toggleAutoCenter">
                        –≤–∫–ª
                    </button>
                </div>
            </div>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–æ–º -->
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomIn">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="zoom-btn" id="zoomOut">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="zoom-btn" id="resetView">
                    <i class="fas fa-crosshairs"></i>
                </button>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
            <div class="coordinates-panel">
                <div class="coord-row">
                    <span class="coord-label">–®–∏—Ä–æ—Ç–∞:</span>
                    <span class="coord-value" id="latitude">‚Äî</span>
                </div>
                <div class="coord-row">
                    <span class="coord-label">–î–æ–ª–≥–æ—Ç–∞:</span>
                    <span class="coord-value" id="longitude">‚Äî</span>
                </div>
                <div class="coord-row">
                    <span class="coord-label">–°–∫–æ—Ä–æ—Å—Ç—å:</span>
                    <span class="coord-value" id="speed">‚Äî –∫–º/—á</span>
                </div>
                <div class="coord-row">
                    <span class="coord-label">–í—ã—Å–æ—Ç–∞:</span>
                    <span class="coord-value" id="altitude">‚Äî –º</span>
                </div>
            </div>
        </div>

        <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="control-panel">
            <button class="control-btn active" id="startGPSBtn">
                <i class="fas fa-satellite"></i>
                <span>–í–∫–ª—é—á–∏—Ç—å GPS</span>
            </button>
            <button class="control-btn" id="calibrateBtn">
                <i class="fas fa-compass"></i>
                <span>–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞</span>
            </button>
            <button class="control-btn" id="clearTrailBtn">
                <i class="fas fa-trash"></i>
                <span>–û—á–∏—Å—Ç–∏—Ç—å</span>
            </button>
            <button class="control-btn" id="saveBtn">
                <i class="fas fa-save"></i>
                <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
            </button>
        </div>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div class="notification" id="notification">
            <i class="fas fa-info-circle"></i>
            <span id="notificationText">–°–æ–æ–±—â–µ–Ω–∏–µ</span>
        </div>

        <!-- –ó–∞–≥—Ä—É–∑—á–∏–∫ -->
        <div class="loader" id="loader">
            <div class="spinner"></div>
        </div>
    </div>

    <script>
        // –ö–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å GPS-—Ç—Ä–µ–∫–∏–Ω–≥–æ–º —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
        class GPSNavigator {
            constructor() {
                this.canvas = document.getElementById('mapCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.trailCanvas = document.getElementById('trailCanvas');
                this.trailCtx = this.trailCanvas.getContext('2d');
                this.locationArrow = document.getElementById('locationArrow');
                
                this.userImage = null;
                this.imagePosition = { x: 0, y: 0 };
                this.scale = 1;
                this.minScale = 0.1;
                this.maxScale = 3;
                
                // –ü–æ–∑–∏—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
                this.arrowPosition = { x: 0, y: 0 };
                this.trailPoints = [];
                this.trailEnabled = true;
                this.autoCenter = true;
                
                // GPS –¥–∞–Ω–Ω—ã–µ
                this.gpsActive = false;
                this.watchId = null;
                this.currentPosition = null;
                this.lastPosition = null;
                this.totalDistance = 0;
                this.gpsScale = 1000; // –º–∞—Å—à—Ç–∞–± GPS –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∫ –ø–∏–∫—Å–µ–ª—è–º –Ω–∞ –∫–∞—Ä—Ç–µ
                
                // –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∑–∏—Ü–∏–π –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
                this.positionHistory = [];
                this.historySize = 5;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                this.startTime = null;
                this.movingTime = 0;
                
                this.init();
            }
            
            init() {
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => this.resizeCanvas(), 100);
                });
                
                this.setupEventListeners();
                this.centerArrow();
                this.showNotification('–ù–∞–≤–∏–≥–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω. –í–∫–ª—é—á–∏—Ç–µ GPS –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è.', 'info', 5000);
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
                this.loadSettings();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å GPS
                this.checkGPSAvailability();
            }
            
            resizeCanvas() {
                const container = document.getElementById('mapContainer');
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
                this.trailCanvas.width = container.clientWidth;
                this.trailCanvas.height = container.clientHeight;
                
                if (this.userImage) {
                    this.centerImage();
                } else {
                    this.drawWelcomeScreen();
                }
                
                this.drawTrail();
            }
            
            drawWelcomeScreen() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // –§–æ–Ω
                const gradient = this.ctx.createLinearGradient(0, 0, this.canvas.width, this.canvas.height);
                gradient.addColorStop(0, '#000000');
                gradient.addColorStop(1, '#1a1a2e');
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // –ò–∫–æ–Ω–∫–∞ –∏ —Ç–µ–∫—Å—Ç
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                
                // –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø—É—Ç–Ω–∏–∫–∏
                this.ctx.font = 'bold 40px FontAwesome';
                this.ctx.fillStyle = 'rgba(52, 199, 89, 0.3)';
                this.ctx.textAlign = 'center';
                
                // –ê–Ω–∏–º–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–∞
                const time = Date.now() / 1000;
                const pulse1 = 0.5 + 0.5 * Math.sin(time);
                const pulse2 = 0.5 + 0.5 * Math.sin(time + 1);
                const pulse3 = 0.5 + 0.5 * Math.sin(time + 2);
                
                this.ctx.fillStyle = `rgba(52, 199, 89, ${pulse1})`;
                this.ctx.fillText('üõ∞Ô∏è', centerX - 100, centerY - 50);
                
                this.ctx.fillStyle = `rgba(52, 199, 89, ${pulse2})`;
                this.ctx.fillText('üõ∞Ô∏è', centerX, centerY - 100);
                
                this.ctx.fillStyle = `rgba(52, 199, 89, ${pulse3})`;
                this.ctx.fillText('üõ∞Ô∏è', centerX + 100, centerY - 50);
                
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                this.ctx.font = 'bold 24px -apple-system, BlinkMacSystemFont';
                this.ctx.fillStyle = '#FFFFFF';
                this.ctx.fillText('GPS –ù–∞–≤–∏–≥–∞—Ç–æ—Ä', centerX, centerY);
                
                // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
                this.ctx.font = '16px -apple-system, BlinkMacSystemFont';
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                this.ctx.fillText('–°—Ç—Ä–µ–ª–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞—à–µ —Ä–µ–∞–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', centerX, centerY + 40);
                this.ctx.fillText('–ù–∞–∂–º–∏—Ç–µ "–í–∫–ª—é—á–∏—Ç—å GPS" –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è', centerX, centerY + 70);
            }
            
            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                if (this.userImage) {
                    this.ctx.save();
                    this.ctx.translate(this.imagePosition.x, this.imagePosition.y);
                    this.ctx.scale(this.scale, this.scale);
                    this.ctx.drawImage(this.userImage, 0, 0);
                    this.ctx.restore();
                    
                    this.drawGrid();
                } else {
                    this.drawWelcomeScreen();
                }
                
                this.updatePositionDisplay();
            }
            
            drawGrid() {
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
                this.ctx.lineWidth = 1;
                
                const gridSize = 50 * this.scale;
                const offsetX = this.imagePosition.x % gridSize;
                const offsetY = this.imagePosition.y % gridSize;
                
                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
                for (let x = -offsetX; x < this.canvas.width; x += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x, this.canvas.height);
                    this.ctx.stroke();
                }
                
                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
                for (let y = -offsetY; y < this.canvas.height; y += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y);
                    this.ctx.lineTo(this.canvas.width, y);
                    this.ctx.stroke();
                }
                
                // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫—Ä–µ—Å—Ç
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                
                this.ctx.strokeStyle = 'rgba(255, 0, 0, 0.3)';
                this.ctx.lineWidth = 2;
                
                this.ctx.beginPath();
                this.ctx.moveTo(centerX - 15, centerY);
                this.ctx.lineTo(centerX + 15, centerY);
                this.ctx.moveTo(centerX, centerY - 15);
                this.ctx.lineTo(centerX, centerY + 15);
                this.ctx.stroke();
            }
            
            drawTrail() {
                if (!this.trailEnabled || this.trailPoints.length < 2) {
                    this.trailCtx.clearRect(0, 0, this.trailCanvas.width, this.trailCanvas.height);
                    return;
                }
                
                this.trailCtx.clearRect(0, 0, this.trailCanvas.width, this.trailCanvas.height);
                
                // –†–∏—Å—É–µ–º –ø—É—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è
                this.trailCtx.strokeStyle = 'rgba(52, 199, 89, 0.5)';
                this.trailCtx.lineWidth = 3;
                this.trailCtx.lineCap = 'round';
                this.trailCtx.lineJoin = 'round';
                
                this.trailCtx.beginPath();
                
                for (let i = 0; i < this.trailPoints.length; i++) {
                    const point = this.trailPoints[i];
                    const screenX = point.x * this.scale + this.imagePosition.x;
                    const screenY = point.y * this.scale + this.imagePosition.y;
                    
                    if (i === 0) {
                        this.trailCtx.moveTo(screenX, screenY);
                    } else {
                        this.trailCtx.lineTo(screenX, screenY);
                    }
                }
                
                this.trailCtx.stroke();
                
                // –†–∏—Å—É–µ–º —Ç–æ—á–∫–∏ –ø—É—Ç–∏
                this.trailCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                for (let i = 0; i < this.trailPoints.length; i += 10) {
                    const point = this.trailPoints[i];
                    const screenX = point.x * this.scale + this.imagePosition.x;
                    const screenY = point.y * this.scale + this.imagePosition.y;
                    
                    this.trailCtx.beginPath();
                    this.trailCtx.arc(screenX, screenY, 3, 0, Math.PI * 2);
                    this.trailCtx.fill();
                }
            }
            
            centerArrow() {
                this.arrowPosition.x = this.canvas.width / 2;
                this.arrowPosition.y = this.canvas.height / 2;
                this.updateArrowPosition();
            }
            
            updateArrowPosition() {
                this.locationArrow.style.left = `${this.arrowPosition.x}px`;
                this.locationArrow.style.top = `${this.arrowPosition.y}px`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É –≤ –ø—É—Ç—å
                if (this.trailEnabled) {
                    const mapX = (this.arrowPosition.x - this.imagePosition.x) / this.scale;
                    const mapY = (this.arrowPosition.y - this.imagePosition.y) / this.scale;
                    
                    this.trailPoints.push({ x: mapX, y: mapY });
                    
                    if (this.trailPoints.length > 1000) {
                        this.trailPoints.shift();
                    }
                    
                    this.drawTrail();
                }
            }
            
            // ===== GPS –§–£–ù–ö–¶–ò–û–ù–ê–õ =====
            
            checkGPSAvailability() {
                if (!navigator.geolocation) {
                    this.showNotification('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é', 'error');
                    document.getElementById('startGPSBtn').disabled = true;
                    document.getElementById('startGPSBtn').innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</span>';
                    return false;
                }
                
                document.getElementById('gpsStatus').innerHTML = 
                    '<i class="fas fa-satellite signal"></i><span>GPS: –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</span>';
                return true;
            }
            
            startGPSTracking() {
                if (!this.checkGPSAvailability()) return;
                
                if (!this.gpsActive) {
                    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≤—ã—Å–æ–∫—É—é —Ç–æ—á–Ω–æ—Å—Ç—å GPS
                    const options = {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    };
                    
                    // –û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            this.onGPSSuccess(position);
                            this.startWatchingGPS();
                        },
                        (error) => this.onGPSError(error),
                        options
                    );
                } else {
                    this.stopGPSTracking();
                }
            }
            
            startWatchingGPS() {
                if (this.watchId) {
                    navigator.geolocation.clearWatch(this.watchId);
                }
                
                const options = {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 1000
                };
                
                this.watchId = navigator.geolocation.watchPosition(
                    (position) => this.onGPSSuccess(position, true),
                    (error) => this.onGPSError(error),
                    options
                );
                
                this.gpsActive = true;
                this.startTime = Date.now();
                document.getElementById('startGPSBtn').classList.remove('active');
                document.getElementById('startGPSBtn').classList.add('tracking');
                document.getElementById('startGPSBtn').innerHTML = '<i class="fas fa-stop"></i><span>–í—ã–∫–ª—é—á–∏—Ç—å GPS</span>';
                
                this.showNotification('GPS –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ. –ü–µ—Ä–µ–º–µ—â–∞–π—Ç–µ—Å—å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏.', 'success');
            }
            
            stopGPSTracking() {
                if (this.watchId) {
                    navigator.geolocation.clearWatch(this.watchId);
                    this.watchId = null;
                }
                
                this.gpsActive = false;
                document.getElementById('startGPSBtn').classList.remove('tracking');
                document.getElementById('startGPSBtn').classList.add('active');
                document.getElementById('startGPSBtn').innerHTML = '<i class="fas fa-satellite"></i><span>–í–∫–ª—é—á–∏—Ç—å GPS</span>';
                
                this.showNotification('GPS –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ', 'info');
            }
            
            onGPSSuccess(position, isUpdate = false) {
                this.currentPosition = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy,
                    altitude: position.coords.altitude,
                    speed: position.coords.speed,
                    heading: position.coords.heading,
                    timestamp: new Date(position.timestamp)
                };
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                this.updateGPSDisplay();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
                this.updateArrowFromGPS();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                this.updateStats();
                
                if (!isUpdate) {
                    this.showNotification('GPS —Å–∏–≥–Ω–∞–ª –ø–æ–ª—É—á–µ–Ω. –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.', 'success');
                }
                
                // –ü—É–ª—å—Å–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
                this.locationArrow.classList.add('pulse');
                setTimeout(() => {
                    this.locationArrow.classList.remove('pulse');
                }, 1000);
            }
            
            onGPSError(error) {
                let message = '–û—à–∏–±–∫–∞ GPS: ';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö iPhone.';
                        this.showNotification(message, 'error', 5000);
                        document.getElementById('gpsStatus').className = 'indicator error';
                        document.getElementById('gpsStatus').innerHTML = 
                            '<i class="fas fa-exclamation-triangle"></i><span>GPS: –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</span>';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –í–∫–ª—é—á–∏—Ç–µ GPS.';
                        this.showNotification(message, 'warning');
                        document.getElementById('gpsStatus').className = 'indicator warning';
                        document.getElementById('gpsStatus').innerHTML = 
                            '<i class="fas fa-exclamation-triangle"></i><span>GPS: –°–∏–≥–Ω–∞–ª –ø–æ—Ç–µ—Ä—è–Ω</span>';
                        break;
                    case error.TIMEOUT:
                        message = '–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è GPS –∏—Å—Ç–µ–∫–ª–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.';
                        this.showNotification(message, 'warning');
                        document.getElementById('gpsStatus').className = 'indicator warning';
                        document.getElementById('gpsStatus').innerHTML = 
                            '<i class="fas fa-clock"></i><span>GPS: –¢–∞–π–º–∞—É—Ç</span>';
                        break;
                    default:
                        message = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ GPS.';
                        this.showNotification(message, 'error');
                }
            }
            
            updateArrowFromGPS() {
                if (!this.currentPosition || !this.lastPosition) {
                    // –ü–µ—Ä–≤–∞—è –ø–æ–∑–∏—Ü–∏—è - —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º
                    this.arrowPosition.x = this.canvas.width / 2;
                    this.arrowPosition.y = this.canvas.height / 2;
                    this.lastPosition = this.currentPosition;
                } else {
                    // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
                    const deltaLat = this.currentPosition.latitude - this.lastPosition.latitude;
                    const deltaLon = this.currentPosition.longitude - this.lastPosition.longitude;
                    
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –ø–∏–∫—Å–µ–ª–∏ —Å —É—á–µ—Ç–æ–º –º–∞—Å—à—Ç–∞–±–∞ GPS
                    const deltaX = deltaLon * this.gpsScale;
                    const deltaY = -deltaLat * this.gpsScale; // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Y (—Å–µ–≤–µ—Ä = –≤–≤–µ—Ä—Ö)
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å—Ç—Ä–µ–ª–∫–∏
                    this.arrowPosition.x += deltaX;
                    this.arrowPosition.y += deltaY;
                    
                    // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Å—Ç—Ä–µ–ª–∫—É –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –¥–≤–∏–∂–µ–Ω–∏—è
                    if (this.currentPosition.heading !== null) {
                        this.locationArrow.style.transform = `translate(-50%, -50%) rotate(${this.currentPosition.heading}deg)`;
                    }
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –∫–∞–∫ –ø—Ä–µ–¥—ã–¥—É—â—É—é
                    this.lastPosition = this.currentPosition;
                }
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
                const padding = 50;
                this.arrowPosition.x = Math.max(padding, Math.min(this.canvas.width - padding, this.arrowPosition.x));
                this.arrowPosition.y = Math.max(padding, Math.min(this.canvas.height - padding, this.arrowPosition.y));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                this.updateArrowPosition();
                this.scrollMapIfNeeded();
            }
            
            scrollMapIfNeeded() {
                if (!this.userImage || !this.autoCenter) return;
                
                const threshold = 100;
                const scrollSpeed = 5;
                
                let needsRedraw = false;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∞—è
                if (this.arrowPosition.x < threshold) {
                    this.imagePosition.x += scrollSpeed;
                    needsRedraw = true;
                } else if (this.arrowPosition.x > this.canvas.width - threshold) {
                    this.imagePosition.x -= scrollSpeed;
                    needsRedraw = true;
                }
                
                if (this.arrowPosition.y < threshold) {
                    this.imagePosition.y += scrollSpeed;
                    needsRedraw = true;
                } else if (this.arrowPosition.y > this.canvas.height - threshold) {
                    this.imagePosition.y -= scrollSpeed;
                    needsRedraw = true;
                }
                
                if (needsRedraw) {
                    this.draw();
                    this.drawTrail();
                }
            }
            
            updateGPSDisplay() {
                if (!this.currentPosition) return;
                
                document.getElementById('latitude').textContent = this.currentPosition.latitude.toFixed(6);
                document.getElementById('longitude').textContent = this.currentPosition.longitude.toFixed(6);
                
                const speed = this.currentPosition.speed ? (this.currentPosition.speed * 3.6).toFixed(1) : '‚Äî';
                document.getElementById('speed').textContent = `${speed} –∫–º/—á`;
                
                const altitude = this.currentPosition.altitude ? Math.round(this.currentPosition.altitude) : '‚Äî';
                document.getElementById('altitude').textContent = `${altitude} –º`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
                document.getElementById('gpsStatus').className = 'indicator good';
                document.getElementById('gpsStatus').innerHTML = 
                    `<i class="fas fa-satellite"></i><span>GPS: ${Math.round(this.currentPosition.accuracy)} –º</span>`;
                
                document.getElementById('accuracyStatus').innerHTML = 
                    `<i class="fas fa-bullseye"></i><span>–¢–æ—á–Ω–æ—Å—Ç—å: ${Math.round(this.currentPosition.accuracy)} –º</span>`;
            }
            
            updateStats() {
                if (!this.currentPosition || !this.lastPosition) return;
                
                // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
                const distance = this.calculateDistance(
                    this.lastPosition.latitude, this.lastPosition.longitude,
                    this.currentPosition.latitude, this.currentPosition.longitude
                );
                
                if (distance > 0) {
                    this.totalDistance += distance;
                    this.movingTime += Date.now() - (this.startTime || Date.now());
                }
            }
            
            calculateDistance(lat1, lon1, lat2, lon2) {
                // –§–æ—Ä–º—É–ª–∞ –≥–∞–≤–µ—Ä—Å–∏–Ω—É—Å–æ–≤ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
                const R = 6371e3; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –º–µ—Ç—Ä–∞—Ö
                const œÜ1 = lat1 * Math.PI / 180;
                const œÜ2 = lat2 * Math.PI / 180;
                const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
                const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
                
                const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                          Math.cos(œÜ1) * Math.cos(œÜ2) *
                          Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                
                return R * c; // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –º–µ—Ç—Ä–∞—Ö
            }
            
            calibrateGPS() {
                this.showNotification('–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞: –ø—Ä–æ–π–¥–∏—Ç–µ 10 –º–µ—Ç—Ä–æ–≤ –ø–æ –ø—Ä—è–º–æ–π –∏ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–≤–µ—Ä—à–∏—Ç—å"', 'info');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É
                const startLat = this.currentPosition?.latitude;
                const startLon = this.currentPosition?.longitude;
                let calibrationPoints = [];
                
                // –°–ª—É—à–∞–µ–º GPS –≤–æ –≤—Ä–µ–º—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
                const calibrateInterval = setInterval(() => {
                    if (this.currentPosition) {
                        calibrationPoints.push({
                            lat: this.currentPosition.latitude,
                            lon: this.currentPosition.longitude
                        });
                        
                        // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ—á–µ–∫, –≤—ã—á–∏—Å–ª—è–µ–º –º–∞—Å—à—Ç–∞–±
                        if (calibrationPoints.length > 10) {
                            const first = calibrationPoints[0];
                            const last = calibrationPoints[calibrationPoints.length - 1];
                            const realDistance = this.calculateDistance(first.lat, first.lon, last.lat, last.lon);
                            const screenDistance = Math.sqrt(
                                Math.pow(this.arrowPosition.x - (this.canvas.width / 2), 2) +
                                Math.pow(this.arrowPosition.y - (this.canvas.height / 2), 2)
                            );
                            
                            if (realDistance > 0 && screenDistance > 0) {
                                this.gpsScale = screenDistance / realDistance;
                                document.getElementById('gpsScale').value = Math.round(this.gpsScale);
                                this.showNotification(`–ú–∞—Å—à—Ç–∞–± —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${Math.round(this.gpsScale)}`, 'success');
                            }
                        }
                    }
                }, 1000);
                
                // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
                const completeBtn = document.createElement('button');
                completeBtn.textContent = '–ó–∞–≤–µ—Ä—à–∏—Ç—å –∫–∞–ª–∏–±—Ä–æ–≤–∫—É';
                completeBtn.style.cssText = `
                    position: absolute;
                    top: 200px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #34C759;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 10px;
                    z-index: 1000;
                `;
                completeBtn.onclick = () => {
                    clearInterval(calibrateInterval);
                    completeBtn.remove();
                    this.showNotification('–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
                };
                
                document.querySelector('.main-content').appendChild(completeBtn);
                
                // –ê–≤—Ç–æ–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    if (completeBtn.parentNode) {
                        completeBtn.click();
                    }
                }, 30000);
            }
            
            // ===== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
            
            loadImage(file) {
                if (!file.type.match('image.*')) {
                    this.showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
                    return;
                }
                
                this.showLoader();
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        this.userImage = img;
                        this.centerImage();
                        this.showNotification(`–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞: ${file.name}`, 'success');
                        this.hideLoader();
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                        localStorage.setItem('lastMap', e.target.result);
                        localStorage.setItem('lastMapName', file.name);
                        
                        // –û—á–∏—â–∞–µ–º –ø—É—Ç—å
                        this.trailPoints = [];
                        this.drawTrail();
                        this.centerArrow();
                    };
                    img.onerror = () => {
                        this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
                        this.hideLoader();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            centerImage() {
                if (!this.userImage) return;
                
                this.imagePosition.x = (this.canvas.width - this.userImage.width * this.scale) / 2;
                this.imagePosition.y = (this.canvas.height - this.userImage.height * this.scale) / 2;
                this.draw();
                this.drawTrail();
            }
            
            zoomIn() {
                if (this.scale < this.maxScale) {
                    this.scale *= 1.2;
                    this.adjustZoomPosition(1.2);
                    this.draw();
                    this.drawTrail();
                }
            }
            
            zoomOut() {
                if (this.scale > this.minScale) {
                    this.scale /= 1.2;
                    this.adjustZoomPosition(1/1.2);
                    this.draw();
                    this.drawTrail();
                }
            }
            
            adjustZoomPosition(factor) {
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                
                this.imagePosition.x = centerX - (centerX - this.imagePosition.x) * factor;
                this.imagePosition.y = centerY - (centerY - this.imagePosition.y) * factor;
            }
            
            resetView() {
                this.scale = 1;
                this.centerImage();
                if (this.autoCenter) {
                    this.centerArrow();
                }
                this.showNotification('–í–∏–¥ —Å–±—Ä–æ—à–µ–Ω', 'info');
            }
            
            clearTrail() {
                this.trailPoints = [];
                this.totalDistance = 0;
                this.drawTrail();
                this.showNotification('–ü—É—Ç—å –æ—á–∏—â–µ–Ω', 'info');
            }
            
            toggleTrail() {
                this.trailEnabled = !this.trailEnabled;
                const trailBtn = document.getElementById('toggleTrail');
                trailBtn.textContent = this.trailEnabled ? '–≤–∫–ª' : '–≤—ã–∫–ª';
                trailBtn.classList.toggle('active', this.trailEnabled);
                
                this.drawTrail();
                this.showNotification(`–°–ª–µ–¥ ${this.trailEnabled ? '–≤–∫–ª—é—á–µ–Ω' : '–≤—ã–∫–ª—é—á–µ–Ω'}`, 'info');
            }
            
            toggleAutoCenter() {
                this.autoCenter = !this.autoCenter;
                const centerBtn = document.getElementById('toggleAutoCenter');
                centerBtn.textContent = this.autoCenter ? '–≤–∫–ª' : '–≤—ã–∫–ª';
                centerBtn.classList.toggle('active', this.autoCenter);
                
                this.showNotification(`–ê–≤—Ç–æ—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ ${this.autoCenter ? '–≤–∫–ª—é—á–µ–Ω–æ' : '–≤—ã–∫–ª—é—á–µ–Ω–æ'}`, 'info');
            }
            
            saveSettings() {
                const settings = {
                    gpsScale: this.gpsScale,
                    trailEnabled: this.trailEnabled,
                    autoCenter: this.autoCenter,
                    arrowPosition: this.arrowPosition,
                    imagePosition: this.imagePosition,
                    scale: this.scale,
                    totalDistance: this.totalDistance,
                    trailPoints: this.trailPoints
                };
                
                localStorage.setItem('gpsNavigatorSettings', JSON.stringify(settings));
                this.showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            }
            
            loadSettings() {
                const saved = localStorage.getItem('gpsNavigatorSettings');
                if (saved) {
                    try {
                        const settings = JSON.parse(saved);
                        this.gpsScale = settings.gpsScale || 1000;
                        this.trailEnabled = settings.trailEnabled !== false;
                        this.autoCenter = settings.autoCenter !== false;
                        this.arrowPosition = settings.arrowPosition || { x: this.canvas.width / 2, y: this.canvas.height / 2 };
                        this.imagePosition = settings.imagePosition || { x: 0, y: 0 };
                        this.scale = settings.scale || 1;
                        this.totalDistance = settings.totalDistance || 0;
                        this.trailPoints = settings.trailPoints || [];
                        
                        document.getElementById('gpsScale').value = this.gpsScale;
                        document.getElementById('toggleTrail').textContent = this.trailEnabled ? '–≤–∫–ª' : '–≤—ã–∫–ª';
                        document.getElementById('toggleTrail').classList.toggle('active', this.trailEnabled);
                        document.getElementById('toggleAutoCenter').textContent = this.autoCenter ? '–≤–∫–ª' : '–≤—ã–∫–ª';
                        document.getElementById('toggleAutoCenter').classList.toggle('active', this.autoCenter);
                        
                        this.updateArrowPosition();
                        this.draw();
                        this.drawTrail();
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', e);
                    }
                }
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–∞—Ä—Ç—ã
                const lastMap = localStorage.getItem('lastMap');
                if (lastMap) {
                    const img = new Image();
                    img.onload = () => {
                        this.userImage = img;
                        this.draw();
                        const mapName = localStorage.getItem('lastMapName') || '–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞';
                        this.showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–∞ ${mapName}`, 'info');
                    };
                    img.src = lastMap;
                }
            }
            
            updatePositionDisplay() {
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
                if (this.userImage) {
                    const centerX = this.canvas.width / 2;
                    const centerY = this.canvas.height / 2;
                    
                    const imgX = Math.round((centerX - this.imagePosition.x) / this.scale);
                    const imgY = Math.round((centerY - this.imagePosition.y) / this.scale);
                }
            }
            
            showNotification(message, type = 'info', duration = 3000) {
                const notification = document.getElementById('notification');
                const text = document.getElementById('notificationText');
                
                notification.className = `notification ${type}`;
                text.textContent = message;
                
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, duration);
            }
            
            showLoader() {
                document.getElementById('loader').classList.add('show');
            }
            
            hideLoader() {
                document.getElementById('loader').classList.remove('show');
            }
            
            setupEventListeners() {
                // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã
                document.getElementById('navUploadBtn').addEventListener('click', () => {
                    document.getElementById('mapUpload').click();
                });
                
                document.getElementById('mapUpload').addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        this.loadImage(e.target.files[0]);
                    }
                });
                
                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ GPS
                document.getElementById('startGPSBtn').addEventListener('click', () => {
                    this.startGPSTracking();
                });
                
                document.getElementById('calibrateBtn').addEventListener('click', () => {
                    this.calibrateGPS();
                });
                
                document.getElementById('clearTrailBtn').addEventListener('click', () => {
                    this.clearTrail();
                });
                
                document.getElementById('saveBtn').addEventListener('click', () => {
                    this.saveSettings();
                });
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                document.getElementById('gpsScale').addEventListener('change', (e) => {
                    this.gpsScale = parseInt(e.target.value) || 1000;
                });
                
                document.getElementById('toggleTrail').addEventListener('click', () => {
                    this.toggleTrail();
                });
                
                document.getElementById('toggleAutoCenter').addEventListener('click', () => {
                    this.toggleAutoCenter();
                });
                
                // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
                document.getElementById('zoomIn').addEventListener('click', () => this.zoomIn());
                document.getElementById('zoomOut').addEventListener('click', () => this.zoomOut());
                document.getElementById('resetView').addEventListener('click', () => this.resetView());
                
                // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã
                let isDragging = false;
                let dragStart = { x: 0, y: 0 };
                
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (this.userImage && e.touches.length === 1) {
                        isDragging = true;
                        dragStart.x = e.touches[0].clientX - this.imagePosition.x;
                        dragStart.y = e.touches[0].clientY - this.imagePosition.y;
                    }
                }, { passive: false });
                
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (isDragging && this.userImage && e.touches.length === 1) {
                        this.imagePosition.x = e.touches[0].clientX - dragStart.x;
                        this.imagePosition.y = e.touches[0].clientY - dragStart.y;
                        this.draw();
                        this.drawTrail();
                    }
                }, { passive: false });
                
                this.canvas.addEventListener('touchend', () => {
                    isDragging = false;
                });
                
                // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∂–µ—Å—Ç–æ–º
                let initialDistance = 0;
                
                this.canvas.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 2 && this.userImage) {
                        initialDistance = Math.hypot(
                            e.touches[0].clientX - e.touches[1].clientX,
                            e.touches[0].clientY - e.touches[1].clientY
                        );
                    }
                });
                
                this.canvas.addEventListener('touchmove', (e) => {
                    if (e.touches.length === 2 && this.userImage && initialDistance > 0) {
                        e.preventDefault();
                        
                        const currentDistance = Math.hypot(
                            e.touches[0].clientX - e.touches[1].clientX,
                            e.touches[0].clientY - e.touches[1].clientY
                        );
                        
                        const delta = currentDistance - initialDistance;
                        if (Math.abs(delta) > 30) {
                            if (delta > 0) {
                                this.zoomIn();
                            } else {
                                this.zoomOut();
                            }
                            initialDistance = currentDistance;
                        }
                    }
                }, { passive: false });
                
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∂–µ—Å—Ç–æ–≤
                document.addEventListener('touchmove', (e) => {
                    if (e.target === this.canvas || e.target.closest('.map-container')) {
                        e.preventDefault();
                    }
                }, { passive: false });
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                window.navigator = new GPSNavigator();
            }, 100);
        });
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∂–µ—Å—Ç–æ–º –Ω–∞ iOS
        document.addEventListener('gesturestart', (e) => {
            e.preventDefault();
        });
    </script>
</body>
</html>